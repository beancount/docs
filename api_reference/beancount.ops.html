<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://beancount.github.io/docs/api_reference/beancount.ops.html">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>beancount.ops - Beancount Documentation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
  <link href="../css/custom.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "beancount.ops";
    var mkdocs_page_input_path = "api_reference/beancount.ops.md";
    var mkdocs_page_url = "/docs/api_reference/beancount.ops.html";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> Beancount Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../index.html">Index</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Outline</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Documentation for Users</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../command_line_accounting_in_context.html">Command Line Accounting in Context</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../the_double_entry_counting_method.html">The Double Entry Counting Method</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../installing_beancount.html">Installing Beancount</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../running_beancount_and_generating_reports.html">Running Beancount and Generating Reports</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../getting_started_with_beancount.html">Getting Started with Beancount</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../beancount_language_syntax.html">Beancount Language Syntax</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../beancount_options_reference.html">Beancount Options Reference</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../precision_tolerances.html">Precision Tolerances</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../beancount_query_language.html">Beancount Query Language</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../beancount_cheat_sheet.html">Beancount Cheat Sheet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../how_inventories_work.html">How Inventories Work</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../exporting_your_portfolio.html">Exporting Your Portfolio</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../tutorial_example.html">Tutorial & Example</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../beancount_history_and_credits.html">Beancount History and Credits</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../a_comparison_of_beancount_and_ledger_hledger.html">A Comparison of Beancount and Ledger Hledger</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../fetching_prices_in_beancount.html">Fetching Prices in Beancount</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../importing_external_data.html">Importing External Data</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Cookbooks & Examples</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../command_line_accounting_cookbook.html">Command Line Accounting Cookbook</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../trading_with_beancount.html">Trading with Beancount</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../stock_vesting_in_beancount.html">Stock Vesting in Beancount</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../sharing_expenses_with_beancount.html">Sharing Expenses with Beancount</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../how_we_share_expenses.html">How We Share Expenses</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../health_care_expenses.html">Health Care Expenses</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../calculating_portolio_returns.html">Calculating Portfolio Returns</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../tracking_medical_claims.html">Tracking Out-of-Network Medical Claims in Beancount</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Documentation for Developers</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../beancount_scripting_plugins.html">Beancount Scripting Plugins</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../beancount_design_doc.html">Beancount Design Doc</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ledgerhub_design_doc.html">Ledgerhub Design Doc</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../external_contributions.html">External Contributions</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Enhancement Proposals & Discussions</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../a_proposal_for_an_improvement_on_inventory_booking.html">A Proposal for an Improvement on Inventory Booking</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../settlement_dates_in_beancount.html">Settlement Dates in Beancount</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../balance_assertions_in_beancount.html">Balance Assertions in Beancount</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../fund_accounting_with_beancount.html">Fund Accounting with Beancount</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../rounding_precision_in_beancount.html">Rounding Precision in Beancount</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Beancount 3</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../beancount_v3.html">Goals & Design</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../installing_beancount_v3.html">Installing Beancount</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../beancount_v3_dependencies.html">Dependencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../beangulp.html">Beangulp</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">API reference</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="index.html">beancount</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="beancount.core.html">beancount.core</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="beancount.loader.html">beancount.loader</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="beancount.ops.html">beancount.ops</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#beancount.ops">beancount.ops</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#beancount.ops.balance">balance</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.balance.BalanceError">BalanceError</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#beancount.ops.balance.BalanceError.__getnewargs__">__getnewargs__()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#beancount.ops.balance.BalanceError.__new__">__new__()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#beancount.ops.balance.BalanceError.__repr__">__repr__()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.balance.check">check()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.balance.get_balance_tolerance">get_balance_tolerance()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#beancount.ops.basicops">basicops</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.basicops.filter_link">filter_link()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.basicops.filter_tag">filter_tag()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.basicops.get_common_accounts">get_common_accounts()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.basicops.group_entries_by_link">group_entries_by_link()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#beancount.ops.compress">compress</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.compress.compress">compress()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.compress.merge">merge()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#beancount.ops.documents">documents</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.documents.DocumentError">DocumentError</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#beancount.ops.documents.DocumentError.__getnewargs__">__getnewargs__()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#beancount.ops.documents.DocumentError.__new__">__new__()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#beancount.ops.documents.DocumentError.__repr__">__repr__()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.documents.find_documents">find_documents()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.documents.process_documents">process_documents()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.documents.verify_document_files_exist">verify_document_files_exist()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#beancount.ops.find_prices">find_prices</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.find_prices.find_balance_currencies">find_balance_currencies()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.find_prices.find_currencies_at_cost">find_currencies_at_cost()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.find_prices.find_currencies_converted">find_currencies_converted()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.find_prices.find_currencies_priced">find_currencies_priced()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#beancount.ops.lifetimes">lifetimes</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.lifetimes.compress_intervals_days">compress_intervals_days()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.lifetimes.compress_lifetimes_days">compress_lifetimes_days()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.lifetimes.get_commodity_lifetimes">get_commodity_lifetimes()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.lifetimes.required_daily_prices">required_daily_prices()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.lifetimes.required_weekly_prices">required_weekly_prices()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.lifetimes.trim_intervals">trim_intervals()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#beancount.ops.pad">pad</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.pad.PadError">PadError</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#beancount.ops.pad.PadError.__getnewargs__">__getnewargs__()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#beancount.ops.pad.PadError.__new__">__new__()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#beancount.ops.pad.PadError.__repr__">__repr__()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.pad.pad">pad()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#beancount.ops.summarize">summarize</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.balance_by_account">balance_by_account()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.cap">cap()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.cap_opt">cap_opt()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.clamp">clamp()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.clamp_opt">clamp_opt()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.clear">clear()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.clear_opt">clear_opt()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.close">close()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.close_opt">close_opt()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.conversions">conversions()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.create_entries_from_balances">create_entries_from_balances()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.get_open_entries">get_open_entries()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.open">open()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.open_opt">open_opt()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.summarize">summarize()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.transfer_balances">transfer_balances()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.truncate">truncate()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#beancount.ops.validation">validation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.ValidationError">ValidationError</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#beancount.ops.validation.ValidationError.__getnewargs__">__getnewargs__()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#beancount.ops.validation.ValidationError.__new__">__new__()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#beancount.ops.validation.ValidationError.__repr__">__repr__()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate">validate()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_active_accounts">validate_active_accounts()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_check_transaction_balances">validate_check_transaction_balances()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_currency_constraints">validate_currency_constraints()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_data_types">validate_data_types()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_documents_paths">validate_documents_paths()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_duplicate_balances">validate_duplicate_balances()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_duplicate_commodities">validate_duplicate_commodities()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_open_close">validate_open_close()</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="beancount.parser.html">beancount.parser</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="beancount.plugins.html">beancount.plugins</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="beancount.scripts.html">beancount.scripts</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="beancount.tools.html">beancount.tools</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="beancount.utils.html">beancount.utils</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Beancount Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
        
          <li>API reference &raquo;</li>
        
      
    
    <li>beancount.ops</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="beancountops">beancount.ops<a class="headerlink" href="#beancountops" title="Permanent link"></a></h1>


  <div class="doc doc-object doc-module">

<a id="beancount.ops"></a>
    <div class="doc doc-contents first">

      <p>Operations on the entries defined in the core modules.</p>
<p>This package contains various functions which operate on lists of entries.</p>



  <div class="doc doc-children">












  <div class="doc doc-object doc-module">



<h2 id="beancount.ops.balance" class="doc doc-heading">
        <code>beancount.ops.balance</code>



<a href="#beancount.ops.balance" class="headerlink" title="Permanent link"></a></h2>

    <div class="doc doc-contents ">

      <p>Automatic padding of gaps between entries.</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-class">



<h3 id="beancount.ops.balance.BalanceError" class="doc doc-heading">
        <code>
beancount.ops.balance.BalanceError            (<span title="tuple">tuple</span>)
        </code>



<a href="#beancount.ops.balance.BalanceError" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>BalanceError(source, message, entry)</p>




  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="beancount.ops.balance.BalanceError.__getnewargs__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">balance</span><span class="o">.</span><span class="n">BalanceError</span><span class="o">.</span><span class="n">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#beancount.ops.balance.BalanceError.__getnewargs__" class="headerlink" title="Permanent link"></a></h4>

    <div class="doc doc-contents ">

      <p>Return self as a plain tuple.  Used by copy and pickle.</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/balance.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">&#39;Return self as a plain tuple.  Used by copy and pickle.&#39;</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="beancount.ops.balance.BalanceError.__new__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">balance</span><span class="o">.</span><span class="n">BalanceError</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#beancount.ops.balance.BalanceError.__new__" class="headerlink" title="Permanent link"></a></h4>

    <div class="doc doc-contents ">

      <p>Create new instance of BalanceError(source, message, entry)</p>

    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="beancount.ops.balance.BalanceError.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">balance</span><span class="o">.</span><span class="n">BalanceError</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#beancount.ops.balance.BalanceError.__repr__" class="headerlink" title="Permanent link"></a></h4>

    <div class="doc doc-contents ">

      <p>Return a nicely formatted representation string</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/balance.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">&#39;Return a nicely formatted representation string&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.balance.check" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">balance</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.balance.check" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Process the balance assertion directives.</p>
<p>For each Balance directive, check that their expected balance corresponds to
the actual balance computed at that time and replace failing ones by new
ones with a flag that indicates failure.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>options_map</strong> – A dict of options, parsed from the input file.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A pair of a list of directives and a list of balance check errors.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/balance.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process the balance assertion directives.</span>

<span class="sd">    For each Balance directive, check that their expected balance corresponds to</span>
<span class="sd">    the actual balance computed at that time and replace failing ones by new</span>
<span class="sd">    ones with a flag that indicates failure.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      options_map: A dict of options, parsed from the input file.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A pair of a list of directives and a list of balance check errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">check_errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># This is similar to realization, but performed in a different order, and</span>
    <span class="c1"># where we only accumulate inventories for accounts that have balance</span>
    <span class="c1"># assertions in them (this saves on time). Here we process the entries one</span>
    <span class="c1"># by one along with the balance checks. We use a temporary realization in</span>
    <span class="c1"># order to hold the incremental tree of balances, so that we can easily get</span>
    <span class="c1"># the amounts of an account&#39;s subaccounts for making checks on parent</span>
    <span class="c1"># accounts.</span>
    <span class="n">real_root</span> <span class="o">=</span> <span class="n">realization</span><span class="o">.</span><span class="n">RealAccount</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Figure out the set of accounts for which we need to compute a running</span>
    <span class="c1"># inventory balance.</span>
    <span class="n">asserted_accounts</span> <span class="o">=</span> <span class="p">{</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Balance</span><span class="p">)}</span>

    <span class="c1"># Add all children accounts of an asserted account to be calculated as well,</span>
    <span class="c1"># and pre-create these accounts, and only those (we&#39;re just being tight to</span>
    <span class="c1"># make sure).</span>
    <span class="n">asserted_match_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">account</span><span class="o">.</span><span class="n">parent_matcher</span><span class="p">(</span><span class="n">account_</span><span class="p">)</span> <span class="k">for</span> <span class="n">account_</span> <span class="ow">in</span> <span class="n">asserted_accounts</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">account_</span> <span class="ow">in</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_accounts</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">account_</span> <span class="ow">in</span> <span class="n">asserted_accounts</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
            <span class="k">match</span><span class="p">(</span><span class="n">account_</span><span class="p">)</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">asserted_match_list</span>
        <span class="p">):</span>
            <span class="n">realization</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">real_root</span><span class="p">,</span> <span class="n">account_</span><span class="p">)</span>

    <span class="c1"># Get the Open directives for each account.</span>
    <span class="n">open_close_map</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_account_open_close</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">):</span>
            <span class="c1"># For each of the postings&#39; accounts, update the balance inventory.</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
                <span class="n">real_account</span> <span class="o">=</span> <span class="n">realization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">real_root</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>

                <span class="c1"># The account will have been created only if we&#39;re meant to track it.</span>
                <span class="k">if</span> <span class="n">real_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Note: Always allow negative lots for the purpose of balancing.</span>
                    <span class="c1"># This error should show up somewhere else than here.</span>
                    <span class="n">real_account</span><span class="o">.</span><span class="n">balance</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Balance</span><span class="p">):</span>
            <span class="c1"># Check that the currency of the balance check is one of the allowed</span>
            <span class="c1"># currencies for that account.</span>
            <span class="n">expected_amount</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">amount</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">open</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">open_close_map</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">check_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">BalanceError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">&quot;Invalid reference to unknown account &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                        <span class="n">entry</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">expected_amount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="nb">open</span>
                <span class="ow">and</span> <span class="nb">open</span><span class="o">.</span><span class="n">currencies</span>
                <span class="ow">and</span> <span class="n">expected_amount</span><span class="o">.</span><span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">open</span><span class="o">.</span><span class="n">currencies</span>
            <span class="p">):</span>
                <span class="n">check_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">BalanceError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">&quot;Invalid currency &#39;</span><span class="si">{}</span><span class="s2">&#39; for Balance directive: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">expected_amount</span><span class="o">.</span><span class="n">currency</span>
                        <span class="p">),</span>
                        <span class="n">entry</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Sum up the current balances for this account and its</span>
            <span class="c1"># sub-accounts. We want to support checks for parent accounts</span>
            <span class="c1"># for the total sum of their subaccounts.</span>
            <span class="c1">#</span>
            <span class="c1"># FIXME: Improve the performance further by computing the balance</span>
            <span class="c1"># for the desired currency only. This won&#39;t allow us to cache in</span>
            <span class="c1"># this way but may be faster, if we&#39;re not asserting all the</span>
            <span class="c1"># currencies. Furthermore, we could probably avoid recomputing the</span>
            <span class="c1"># balance if a subtree of positions hasn&#39;t been invalidated by a new</span>
            <span class="c1"># position added to the realization. Do this.</span>
            <span class="n">real_account</span> <span class="o">=</span> <span class="n">realization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">real_root</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">real_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Missing </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
            <span class="n">subtree_balance</span> <span class="o">=</span> <span class="n">realization</span><span class="o">.</span><span class="n">compute_balance</span><span class="p">(</span><span class="n">real_account</span><span class="p">,</span> <span class="n">leaf_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Get only the amount in the desired currency.</span>
            <span class="n">balance_amount</span> <span class="o">=</span> <span class="n">subtree_balance</span><span class="o">.</span><span class="n">get_currency_units</span><span class="p">(</span><span class="n">expected_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>

            <span class="c1"># Check if the amount is within bounds of the expected amount.</span>
            <span class="n">diff_amount</span> <span class="o">=</span> <span class="n">amount</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">balance_amount</span><span class="p">,</span> <span class="n">expected_amount</span><span class="p">)</span>

            <span class="c1"># Use the specified tolerance or automatically infer it.</span>
            <span class="n">tolerance</span> <span class="o">=</span> <span class="n">get_balance_tolerance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff_amount</span><span class="o">.</span><span class="n">number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
                <span class="n">check_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">BalanceError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="p">(</span>
                            <span class="s2">&quot;Balance failed for &#39;</span><span class="si">{}</span><span class="s2">&#39;: &quot;</span>
                            <span class="s2">&quot;expected </span><span class="si">{}</span><span class="s2"> != accumulated </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">)&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                            <span class="n">expected_amount</span><span class="p">,</span>
                            <span class="n">balance_amount</span><span class="p">,</span>
                            <span class="nb">abs</span><span class="p">(</span><span class="n">diff_amount</span><span class="o">.</span><span class="n">number</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;too much&quot;</span> <span class="k">if</span> <span class="n">diff_amount</span><span class="o">.</span><span class="n">number</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;too little&quot;</span><span class="p">),</span>
                        <span class="p">),</span>
                        <span class="n">entry</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Substitute the entry by a failing entry, with the diff_amount</span>
                <span class="c1"># field set on it. I&#39;m not entirely sure that this is the best</span>
                <span class="c1"># of ideas, maybe leaving the original check intact and insert a</span>
                <span class="c1"># new error entry might be more functional or easier to</span>
                <span class="c1"># understand.</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">diff_amount</span><span class="o">=</span><span class="n">diff_amount</span><span class="p">)</span>

        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">check_errors</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.balance.get_balance_tolerance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">balance</span><span class="o">.</span><span class="n">get_balance_tolerance</span><span class="p">(</span><span class="n">balance_entry</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.balance.get_balance_tolerance" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Get the tolerance amount for a single entry.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>balance_entry</strong> – An instance of data.Balance</p></li>
            <li><p><strong>options_map</strong> – An options dict, as per the parser.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A Decimal, the amount of tolerance implied by the directive.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/balance.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_balance_tolerance</span><span class="p">(</span><span class="n">balance_entry</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the tolerance amount for a single entry.</span>

<span class="sd">    Args:</span>
<span class="sd">      balance_entry: An instance of data.Balance</span>
<span class="sd">      options_map: An options dict, as per the parser.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A Decimal, the amount of tolerance implied by the directive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">balance_entry</span><span class="o">.</span><span class="n">tolerance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Use the balance-specific tolerance override if it is provided.</span>
        <span class="n">tolerance</span> <span class="o">=</span> <span class="n">balance_entry</span><span class="o">.</span><span class="n">tolerance</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">expo</span> <span class="o">=</span> <span class="n">balance_entry</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">()</span><span class="o">.</span><span class="n">exponent</span>
        <span class="k">if</span> <span class="n">expo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Be generous and always allow twice the multiplier on Balance and</span>
            <span class="c1"># Pad because the user creates these and the rounding of those</span>
            <span class="c1"># balances may often be further off than those used within a single</span>
            <span class="c1"># transaction.</span>
            <span class="n">tolerance</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s2">&quot;inferred_tolerance_multiplier&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">tolerance</span> <span class="o">=</span> <span class="n">ONE</span><span class="o">.</span><span class="n">scaleb</span><span class="p">(</span><span class="n">expo</span><span class="p">)</span> <span class="o">*</span> <span class="n">tolerance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tolerance</span> <span class="o">=</span> <span class="n">ZERO</span>

    <span class="k">return</span> <span class="n">tolerance</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="beancount.ops.basicops" class="doc doc-heading">
        <code>beancount.ops.basicops</code>



<a href="#beancount.ops.basicops" class="headerlink" title="Permanent link"></a></h2>

    <div class="doc doc-contents ">

      <p>Basic filtering and aggregation operations on lists of entries.</p>
<p>This module contains some common basic operations on entries that are complex
enough not to belong in core/data.py.</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.basicops.filter_link" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">basicops</span><span class="o">.</span><span class="n">filter_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">entries</span><span class="p">)</span></code>


<a href="#beancount.ops.basicops.filter_link" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Yield all the entries which have the given link.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>link</strong> – A string, the link we are interested in.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Yields:
  Every entry in 'entries' that links to 'link.</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/basicops.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">filter_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">entries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yield all the entries which have the given link.</span>

<span class="sd">    Args:</span>
<span class="sd">      link: A string, the link we are interested in.</span>
<span class="sd">    Yields:</span>
<span class="sd">      Every entry in &#39;entries&#39; that links to &#39;link.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">links</span> <span class="ow">and</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">entry</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.basicops.filter_tag" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">basicops</span><span class="o">.</span><span class="n">filter_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">entries</span><span class="p">)</span></code>


<a href="#beancount.ops.basicops.filter_tag" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Yield all the entries which have the given tag.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>tag</strong> – A string, the tag we are interested in.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Yields:
  Every entry in 'entries' that tags to 'tag.</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/basicops.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">filter_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">entries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yield all the entries which have the given tag.</span>

<span class="sd">    Args:</span>
<span class="sd">      tag: A string, the tag we are interested in.</span>
<span class="sd">    Yields:</span>
<span class="sd">      Every entry in &#39;entries&#39; that tags to &#39;tag.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">entry</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.basicops.get_common_accounts" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">basicops</span><span class="o">.</span><span class="n">get_common_accounts</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span></code>


<a href="#beancount.ops.basicops.get_common_accounts" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Compute the intersection of the accounts on the given entries.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of Transaction entries to process.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A set of strings, the names of the common accounts from these
entries.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/basicops.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_common_accounts</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the intersection of the accounts on the given entries.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of Transaction entries to process.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A set of strings, the names of the common accounts from these</span>
<span class="sd">      entries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">)</span>

    <span class="c1"># If there is a single entry, the common accounts to it is all its accounts.</span>
    <span class="c1"># Note that this also works with no entries (yields an empty set).</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">intersection</span> <span class="o">=</span> <span class="p">{</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span> <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">postings</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intersection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">entries_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span> <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="nb">next</span><span class="p">(</span><span class="n">entries_iter</span><span class="p">)</span><span class="o">.</span><span class="n">postings</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries_iter</span><span class="p">:</span>
            <span class="n">accounts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span> <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">)</span>
            <span class="n">intersection</span> <span class="o">&amp;=</span> <span class="n">accounts</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">intersection</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">intersection</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.basicops.group_entries_by_link" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">basicops</span><span class="o">.</span><span class="n">group_entries_by_link</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span></code>


<a href="#beancount.ops.basicops.group_entries_by_link" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Group the list of entries by link.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives/transactions to process.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A dict of link-name to list of entries.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/basicops.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">group_entries_by_link</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Group the list of entries by link.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives/transactions to process.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A dict of link-name to list of entries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">link_groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">links</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="n">link_groups</span><span class="p">[</span><span class="n">link</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">link_groups</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="beancount.ops.compress" class="doc doc-heading">
        <code>beancount.ops.compress</code>



<a href="#beancount.ops.compress" class="headerlink" title="Permanent link"></a></h2>

    <div class="doc doc-contents ">

      <p>Compress multiple entries into a single one.</p>
<p>This can be used during import to compress the effective output, for accounts
with a large number of similar entries. For example, I had a trading account
which would pay out interest every single day. I have no desire to import the
full detail of these daily interests, and compressing these interest-only
entries to monthly ones made sense. This is the code that was used to carry this
out.</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.compress.compress" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">compress</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">predicate</span><span class="p">)</span></code>


<a href="#beancount.ops.compress.compress" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Compress multiple transactions into single transactions.</p>
<p>Replace consecutive sequences of Transaction entries that fulfill the given
predicate by a single entry at the date of the last matching entry.
'predicate' is the function that determines if an entry should be
compressed.</p>
<p>This can be used to simply a list of transactions that are similar and occur
frequently. As an example, in a retail FOREX trading account, differential
interest of very small amounts is paid every day; it is not relevant to look
at the full detail of this interest unless there are other transactions. You
can use this to compress it into single entries between other types of
transactions.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>predicate</strong> – A callable which accepts an entry and return true if the entry
  is intended to be compressed.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of directives, with compressible transactions replaced by a summary
equivalent.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/compress.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">predicate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compress multiple transactions into single transactions.</span>

<span class="sd">    Replace consecutive sequences of Transaction entries that fulfill the given</span>
<span class="sd">    predicate by a single entry at the date of the last matching entry.</span>
<span class="sd">    &#39;predicate&#39; is the function that determines if an entry should be</span>
<span class="sd">    compressed.</span>

<span class="sd">    This can be used to simply a list of transactions that are similar and occur</span>
<span class="sd">    frequently. As an example, in a retail FOREX trading account, differential</span>
<span class="sd">    interest of very small amounts is paid every day; it is not relevant to look</span>
<span class="sd">    at the full detail of this interest unless there are other transactions. You</span>
<span class="sd">    can use this to compress it into single entries between other types of</span>
<span class="sd">    transactions.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      predicate: A callable which accepts an entry and return true if the entry</span>
<span class="sd">          is intended to be compressed.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of directives, with compressible transactions replaced by a summary</span>
<span class="sd">      equivalent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pending</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">predicate</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
            <span class="c1"># Save for compressing later.</span>
            <span class="n">pending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Compress and output all the pending entries.</span>
            <span class="k">if</span> <span class="n">pending</span><span class="p">:</span>
                <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">pending</span><span class="p">,</span> <span class="n">pending</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">pending</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># Output the differing entry.</span>
            <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pending</span><span class="p">:</span>
        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">pending</span><span class="p">,</span> <span class="n">pending</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">new_entries</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.compress.merge" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">compress</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">prototype_txn</span><span class="p">)</span></code>


<a href="#beancount.ops.compress.merge" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Merge the postings of a list of Transactions into a single one.</p>
<p>Merge postings the given entries into a single entry with the Transaction
attributes of the prototype. Return the new entry. The combined list of
postings are merged if everything about the postings is the same except the
number.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>prototype_txn</strong> – A Transaction which is used to create the compressed
  Transaction instance. Its list of postings is ignored.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A new Transaction instance which contains all the postings from the input
entries merged together.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/compress.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">prototype_txn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge the postings of a list of Transactions into a single one.</span>

<span class="sd">    Merge postings the given entries into a single entry with the Transaction</span>
<span class="sd">    attributes of the prototype. Return the new entry. The combined list of</span>
<span class="sd">    postings are merged if everything about the postings is the same except the</span>
<span class="sd">    number.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      prototype_txn: A Transaction which is used to create the compressed</span>
<span class="sd">          Transaction instance. Its list of postings is ignored.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new Transaction instance which contains all the postings from the input</span>
<span class="sd">      entries merged together.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Aggregate the postings together. This is a mapping of numberless postings</span>
    <span class="c1"># to their number of units.</span>
    <span class="n">postings_map</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">Decimal</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">filter_txns</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="c1"># We strip the number off the posting to act as an aggregation key.</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span>
                <span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                <span class="n">Amount</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">),</span>
                <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                <span class="n">posting</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">postings_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span>

    <span class="c1"># Create a new transaction with the aggregated postings.</span>
    <span class="n">new_entry</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">(</span>
        <span class="n">prototype_txn</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
        <span class="n">prototype_txn</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
        <span class="n">prototype_txn</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
        <span class="n">prototype_txn</span><span class="o">.</span><span class="n">payee</span><span class="p">,</span>
        <span class="n">prototype_txn</span><span class="o">.</span><span class="n">narration</span><span class="p">,</span>
        <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span>
        <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span>
        <span class="p">[],</span>
    <span class="p">)</span>

    <span class="c1"># Sort for at least some stability of output.</span>
    <span class="n">sorted_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">postings_map</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="c1"># Issue the merged postings.</span>
    <span class="k">for</span> <span class="n">posting</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">sorted_items</span><span class="p">:</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">Amount</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
        <span class="n">new_entry</span><span class="o">.</span><span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span>
                <span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                <span class="n">units</span><span class="p">,</span>
                <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                <span class="n">posting</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                <span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entry</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="beancount.ops.documents" class="doc doc-heading">
        <code>beancount.ops.documents</code>



<a href="#beancount.ops.documents" class="headerlink" title="Permanent link"></a></h2>

    <div class="doc doc-contents ">

      <p>Everything that relates to creating the Document directives.</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-class">



<h3 id="beancount.ops.documents.DocumentError" class="doc doc-heading">
        <code>
beancount.ops.documents.DocumentError            (<span title="tuple">tuple</span>)
        </code>



<a href="#beancount.ops.documents.DocumentError" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>DocumentError(source, message, entry)</p>




  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="beancount.ops.documents.DocumentError.__getnewargs__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">documents</span><span class="o">.</span><span class="n">DocumentError</span><span class="o">.</span><span class="n">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#beancount.ops.documents.DocumentError.__getnewargs__" class="headerlink" title="Permanent link"></a></h4>

    <div class="doc doc-contents ">

      <p>Return self as a plain tuple.  Used by copy and pickle.</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/documents.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">&#39;Return self as a plain tuple.  Used by copy and pickle.&#39;</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="beancount.ops.documents.DocumentError.__new__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">documents</span><span class="o">.</span><span class="n">DocumentError</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#beancount.ops.documents.DocumentError.__new__" class="headerlink" title="Permanent link"></a></h4>

    <div class="doc doc-contents ">

      <p>Create new instance of DocumentError(source, message, entry)</p>

    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="beancount.ops.documents.DocumentError.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">documents</span><span class="o">.</span><span class="n">DocumentError</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#beancount.ops.documents.DocumentError.__repr__" class="headerlink" title="Permanent link"></a></h4>

    <div class="doc doc-contents ">

      <p>Return a nicely formatted representation string</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/documents.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">&#39;Return a nicely formatted representation string&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.documents.find_documents" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">documents</span><span class="o">.</span><span class="n">find_documents</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">input_filename</span><span class="p">,</span> <span class="n">accounts_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#beancount.ops.documents.find_documents" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Find dated document files under the given directory.</p>
<p>If a restricting set of accounts is provided in 'accounts_only', only return
entries that correspond to one of the given accounts.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>directory</strong> – A string, the name of the root of the directory hierarchy to be searched.</p></li>
            <li><p><strong>input_filename</strong> – The name of the file to be used for the Document directives. This is
also used to resolve relative directory names.</p></li>
            <li><p><strong>accounts_only</strong> – A set of valid accounts strings to search for.</p></li>
            <li><p><strong>strict</strong> – A boolean, set to true if you want to generate errors on documents
found in accounts not provided in accounts_only. This is only meaningful
if accounts_only is specified.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of new Document objects that were created from the files found, and a list
of new errors generated.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/documents.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">find_documents</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">input_filename</span><span class="p">,</span> <span class="n">accounts_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find dated document files under the given directory.</span>

<span class="sd">    If a restricting set of accounts is provided in &#39;accounts_only&#39;, only return</span>
<span class="sd">    entries that correspond to one of the given accounts.</span>

<span class="sd">    Args:</span>
<span class="sd">      directory: A string, the name of the root of the directory hierarchy to be searched.</span>
<span class="sd">      input_filename: The name of the file to be used for the Document directives. This is</span>
<span class="sd">        also used to resolve relative directory names.</span>
<span class="sd">      accounts_only: A set of valid accounts strings to search for.</span>
<span class="sd">      strict: A boolean, set to true if you want to generate errors on documents</span>
<span class="sd">        found in accounts not provided in accounts_only. This is only meaningful</span>
<span class="sd">        if accounts_only is specified.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new Document objects that were created from the files found, and a list</span>
<span class="sd">      of new errors generated.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Compute the documents directory name relative to the beancount input</span>
    <span class="c1"># file itself.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">input_directory</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_filename</span><span class="p">)</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_directory</span><span class="p">,</span> <span class="n">directory</span><span class="p">)))</span>

    <span class="c1"># If the directory does not exist, just generate an error and return.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">DocumentError</span><span class="p">(</span>
            <span class="n">meta</span><span class="p">,</span> <span class="s2">&quot;Document root &#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory</span><span class="p">),</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">([],</span> <span class="p">[</span><span class="n">error</span><span class="p">])</span>

    <span class="c1"># Walk the hierarchy of files.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">account_name</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">account</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="c1"># Look for files that have a dated filename.</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d\d\d\d)-(\d\d)-(\d\d).(.*)&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># If a restricting set of accounts was specified, skip document</span>
            <span class="c1"># directives found in accounts with no corresponding account name.</span>
            <span class="k">if</span> <span class="n">accounts_only</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">account_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">accounts_only</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">account_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">account</span><span class="p">)</span> <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">accounts_only</span><span class="p">):</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">DocumentError</span><span class="p">(</span>
                                <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                <span class="s2">&quot;Document &#39;</span><span class="si">{}</span><span class="s2">&#39; found in child account </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">filename</span><span class="p">,</span> <span class="n">account_name</span>
                                <span class="p">),</span>
                                <span class="kc">None</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">account_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">accounts_only</span><span class="p">):</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">DocumentError</span><span class="p">(</span>
                                <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                <span class="s2">&quot;Document &#39;</span><span class="si">{}</span><span class="s2">&#39; found in parent account </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">filename</span><span class="p">,</span> <span class="n">account_name</span>
                                <span class="p">),</span>
                                <span class="kc">None</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Create a new directive.</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">DocumentError</span><span class="p">(</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s2">&quot;Invalid date on document file &#39;</span><span class="si">{}</span><span class="s2">&#39;: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">exc</span><span class="p">),</span>
                        <span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span>
                    <span class="n">meta</span><span class="p">,</span>
                    <span class="n">date</span><span class="p">,</span>
                    <span class="n">account_name</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.documents.process_documents" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">documents</span><span class="o">.</span><span class="n">process_documents</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.documents.process_documents" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Check files for document directives and create documents directives automatically.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of all directives parsed from the file.</p></li>
            <li><p><strong>options_map</strong> – An options dict, as is output by the parser.
We're using its 'filename' option to figure out relative path to
search for documents.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A pair of list of all entries (including new ones), and errors
generated during the process of creating document directives.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/documents.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">process_documents</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check files for document directives and create documents directives automatically.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of all directives parsed from the file.</span>
<span class="sd">      options_map: An options dict, as is output by the parser.</span>
<span class="sd">        We&#39;re using its &#39;filename&#39; option to figure out relative path to</span>
<span class="sd">        search for documents.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A pair of list of all entries (including new ones), and errors</span>
<span class="sd">      generated during the process of creating document directives.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>

    <span class="c1"># Detect filenames that should convert into entries.</span>
    <span class="n">autodoc_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">autodoc_errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">document_dirs</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s2">&quot;documents&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">document_dirs</span><span class="p">:</span>
        <span class="c1"># Restrict to the list of valid accounts only.</span>
        <span class="n">accounts</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_accounts</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

        <span class="c1"># Accumulate all the entries.</span>
        <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">,</span> <span class="n">document_dirs</span><span class="p">):</span>
            <span class="n">new_entries</span><span class="p">,</span> <span class="n">new_errors</span> <span class="o">=</span> <span class="n">find_documents</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">accounts</span><span class="p">)</span>
            <span class="n">autodoc_entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_entries</span><span class="p">)</span>
            <span class="n">autodoc_errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_errors</span><span class="p">)</span>

    <span class="c1"># Merge the two lists of entries and errors. Keep the entries sorted.</span>
    <span class="n">entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">autodoc_entries</span><span class="p">)</span>
    <span class="n">entries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">entry_sortkey</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">autodoc_errors</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.documents.verify_document_files_exist" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">documents</span><span class="o">.</span><span class="n">verify_document_files_exist</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.documents.verify_document_files_exist" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Verify that the document entries point to existing files.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – a list of directives whose documents need to be validated.</p></li>
            <li><p><strong>unused_options_map</strong> – A parser options dict. We're not using it.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>The same list of entries, and a list of new errors, if any were encountered.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/documents.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">verify_document_files_exist</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify that the document entries point to existing files.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: a list of directives whose documents need to be validated.</span>
<span class="sd">      unused_options_map: A parser options dict. We&#39;re not using it.</span>
<span class="sd">    Returns:</span>
<span class="sd">      The same list of entries, and a list of new errors, if any were encountered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Document</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">DocumentError</span><span class="p">(</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="s1">&#39;File does not exist: &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span> <span class="n">entry</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="beancount.ops.find_prices" class="doc doc-heading">
        <code>beancount.ops.find_prices</code>



<a href="#beancount.ops.find_prices" class="headerlink" title="Permanent link"></a></h2>

    <div class="doc doc-contents ">

      <p>A library of codes create price fetching jobs from strings and files.</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.find_prices.find_balance_currencies" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">find_prices</span><span class="o">.</span><span class="n">find_balance_currencies</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#beancount.ops.find_prices.find_balance_currencies" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Return currencies relevant for the given date.</p>
<p>This computes the account balances as of the date, and returns the union of:
a) The currencies held at cost, and
b) Currency pairs from previous conversions, but only for currencies with
   non-zero balances.</p>
<p>This is intended to produce the list of currencies whose prices are relevant
at a particular date, based on previous history.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>date</strong> – A datetime.date instance.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A set of (base, quote) currencies.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/find_prices.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">find_balance_currencies</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return currencies relevant for the given date.</span>

<span class="sd">    This computes the account balances as of the date, and returns the union of:</span>
<span class="sd">    a) The currencies held at cost, and</span>
<span class="sd">    b) Currency pairs from previous conversions, but only for currencies with</span>
<span class="sd">       non-zero balances.</span>

<span class="sd">    This is intended to produce the list of currencies whose prices are relevant</span>
<span class="sd">    at a particular date, based on previous history.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A set of (base, quote) currencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute the balances.</span>
    <span class="n">currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">currencies_on_books</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">balances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">summarize</span><span class="o">.</span><span class="n">balance_by_account</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">balance</span> <span class="ow">in</span> <span class="n">balances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">balance</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Add currencies held at cost.</span>
                <span class="n">currencies</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add regular currencies.</span>
                <span class="n">currencies_on_books</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>

    <span class="c1"># Create currency pairs from the currencies which are on account balances.</span>
    <span class="c1"># In order to figure out the quote currencies, we use the list of price</span>
    <span class="c1"># conversions until this date.</span>
    <span class="n">converted</span> <span class="o">=</span> <span class="n">find_currencies_converted</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="o">|</span> <span class="n">find_currencies_priced</span><span class="p">(</span>
        <span class="n">entries</span><span class="p">,</span> <span class="n">date</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">cbase</span> <span class="ow">in</span> <span class="n">currencies_on_books</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">base_quote</span> <span class="ow">in</span> <span class="n">converted</span><span class="p">:</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">base_quote</span>
            <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="n">cbase</span><span class="p">:</span>
                <span class="n">currencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_quote</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">currencies</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.find_prices.find_currencies_at_cost" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">find_prices</span><span class="o">.</span><span class="n">find_currencies_at_cost</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#beancount.ops.find_prices.find_currencies_at_cost" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Return all currencies that were held at cost at some point.</p>
<p>This returns all of them, even if not on the books at a particular point in
time. This code does not look at account balances.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>date</strong> – A datetime.date instance.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of (base, quote) currencies.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/find_prices.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">find_currencies_at_cost</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return all currencies that were held at cost at some point.</span>

<span class="sd">    This returns all of them, even if not on the books at a particular point in</span>
<span class="sd">    time. This code does not look at account balances.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of (base, quote) currencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">currencies</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">currencies</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.find_prices.find_currencies_converted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">find_prices</span><span class="o">.</span><span class="n">find_currencies_converted</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#beancount.ops.find_prices.find_currencies_converted" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Return currencies from price conversions.</p>
<p>This function looks at all price conversions that occurred until some date
and produces a list of them. Note: This does not include Price directives,
only postings with price conversions.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>date</strong> – A datetime.date instance.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of (base, quote) currencies.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/find_prices.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">find_currencies_converted</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return currencies from price conversions.</span>

<span class="sd">    This function looks at all price conversions that occurred until some date</span>
<span class="sd">    and produces a list of them. Note: This does not include Price directives,</span>
<span class="sd">    only postings with price conversions.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of (base, quote) currencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span>
            <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">currencies</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">price</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">currencies</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.find_prices.find_currencies_priced" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">find_prices</span><span class="o">.</span><span class="n">find_currencies_priced</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#beancount.ops.find_prices.find_currencies_priced" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Return currencies seen in Price directives.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>date</strong> – A datetime.date instance.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of (base, quote) currencies.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/find_prices.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">find_currencies_priced</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return currencies seen in Price directives.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of (base, quote) currencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Price</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">currencies</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">entry</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">currencies</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="beancount.ops.lifetimes" class="doc doc-heading">
        <code>beancount.ops.lifetimes</code>



<a href="#beancount.ops.lifetimes" class="headerlink" title="Permanent link"></a></h2>

    <div class="doc doc-contents ">

      <p>Given a Beancount ledger, compute time intervals where we hold each commodity.</p>
<p>This script computes, for each commodity, which time intervals it is required at.
This can then be used to identify a list of dates at which we need to fetch prices
in order to properly fill the price database.</p>



  <div class="doc doc-children">












  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.lifetimes.compress_intervals_days" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">lifetimes</span><span class="o">.</span><span class="n">compress_intervals_days</span><span class="p">(</span><span class="n">intervals</span><span class="p">,</span> <span class="n">num_days</span><span class="p">)</span></code>


<a href="#beancount.ops.lifetimes.compress_intervals_days" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Compress a list of date pairs to ignore short stretches of unused days.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>intervals</strong> – A list of pairs of datetime.date instances.</p></li>
            <li><p><strong>num_days</strong> – An integer, the number of unused days to require for intervals
to be distinct, to allow a gap.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A new dict of lifetimes map where some intervals may have been joined.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/lifetimes.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compress_intervals_days</span><span class="p">(</span><span class="n">intervals</span><span class="p">,</span> <span class="n">num_days</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compress a list of date pairs to ignore short stretches of unused days.</span>

<span class="sd">    Args:</span>
<span class="sd">      intervals: A list of pairs of datetime.date instances.</span>
<span class="sd">      num_days: An integer, the number of unused days to require for intervals</span>
<span class="sd">        to be distinct, to allow a gap.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new dict of lifetimes map where some intervals may have been joined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ignore_interval</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">num_days</span><span class="p">)</span>
    <span class="n">new_intervals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">iter_intervals</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span>
    <span class="n">last_begin</span><span class="p">,</span> <span class="n">last_end</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iter_intervals</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">date_begin</span><span class="p">,</span> <span class="n">date_end</span> <span class="ow">in</span> <span class="n">iter_intervals</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">date_begin</span> <span class="o">-</span> <span class="n">last_end</span> <span class="o">&lt;</span> <span class="n">ignore_interval</span><span class="p">:</span>
            <span class="c1"># Compress.</span>
            <span class="n">last_end</span> <span class="o">=</span> <span class="n">date_end</span>
            <span class="k">continue</span>
        <span class="n">new_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">last_begin</span><span class="p">,</span> <span class="n">last_end</span><span class="p">))</span>
        <span class="n">last_begin</span><span class="p">,</span> <span class="n">last_end</span> <span class="o">=</span> <span class="n">date_begin</span><span class="p">,</span> <span class="n">date_end</span>
    <span class="n">new_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">last_begin</span><span class="p">,</span> <span class="n">last_end</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_intervals</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.lifetimes.compress_lifetimes_days" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">lifetimes</span><span class="o">.</span><span class="n">compress_lifetimes_days</span><span class="p">(</span><span class="n">lifetimes_map</span><span class="p">,</span> <span class="n">num_days</span><span class="p">)</span></code>


<a href="#beancount.ops.lifetimes.compress_lifetimes_days" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Compress a lifetimes map to ignore short stretches of unused days.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>lifetimes_map</strong> – A dict of currency intervals as returned by get_commodity_lifetimes.</p></li>
            <li><p><strong>num_days</strong> – An integer, the number of unused days to ignore.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A new dict of lifetimes map where some intervals may have been joined.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/lifetimes.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compress_lifetimes_days</span><span class="p">(</span><span class="n">lifetimes_map</span><span class="p">,</span> <span class="n">num_days</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compress a lifetimes map to ignore short stretches of unused days.</span>

<span class="sd">    Args:</span>
<span class="sd">      lifetimes_map: A dict of currency intervals as returned by get_commodity_lifetimes.</span>
<span class="sd">      num_days: An integer, the number of unused days to ignore.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new dict of lifetimes map where some intervals may have been joined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">currency_pair</span><span class="p">:</span> <span class="n">compress_intervals_days</span><span class="p">(</span><span class="n">intervals</span><span class="p">,</span> <span class="n">num_days</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">currency_pair</span><span class="p">,</span> <span class="n">intervals</span> <span class="ow">in</span> <span class="n">lifetimes_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.lifetimes.get_commodity_lifetimes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">lifetimes</span><span class="o">.</span><span class="n">get_commodity_lifetimes</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span></code>


<a href="#beancount.ops.lifetimes.get_commodity_lifetimes" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Given a list of directives, figure out the life of each commodity.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A dict of (currency, cost-currency) commodity strings to lists of (start,
end) datetime.date pairs. The dates are inclusive of the day the commodity
was seen; the end/last dates are one day <em>after</em> the last date seen.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/lifetimes.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_commodity_lifetimes</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a list of directives, figure out the life of each commodity.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A dict of (currency, cost-currency) commodity strings to lists of (start,</span>
<span class="sd">      end) datetime.date pairs. The dates are inclusive of the day the commodity</span>
<span class="sd">      was seen; the end/last dates are one day _after_ the last date seen.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lifetimes</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="c1"># The current set of active commodities.</span>
    <span class="n">commodities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># The current balances across all accounts.</span>
    <span class="n">balances</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="c1"># Process only transaction entries.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Update the balance of affected accounts and check locally whether that</span>
        <span class="c1"># triggered a change in the set of commodities.</span>
        <span class="n">commodities_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="n">balances</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>
            <span class="n">commodities_before</span> <span class="o">=</span> <span class="n">balance</span><span class="o">.</span><span class="n">currency_pairs</span><span class="p">()</span>
            <span class="n">balance</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>
            <span class="n">commodities_after</span> <span class="o">=</span> <span class="n">balance</span><span class="o">.</span><span class="n">currency_pairs</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">commodities_after</span> <span class="o">!=</span> <span class="n">commodities_before</span><span class="p">:</span>
                <span class="n">commodities_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># If there was a change in one of the affected account&#39;s list of</span>
        <span class="c1"># commodities, recompute the total set globally. This should not</span>
        <span class="c1"># occur very frequently.</span>
        <span class="k">if</span> <span class="n">commodities_changed</span><span class="p">:</span>
            <span class="n">new_commodities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">inv</span><span class="o">.</span><span class="n">currency_pairs</span><span class="p">()</span> <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="n">balances</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">new_commodities</span> <span class="o">!=</span> <span class="n">commodities</span><span class="p">:</span>
                <span class="c1"># The new global set of commodities has changed; update our</span>
                <span class="c1"># the dictionary of intervals.</span>
                <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="n">new_commodities</span> <span class="o">-</span> <span class="n">commodities</span><span class="p">:</span>
                    <span class="n">lifetimes</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="n">commodities</span> <span class="o">-</span> <span class="n">new_commodities</span><span class="p">:</span>
                    <span class="n">lifetime</span> <span class="o">=</span> <span class="n">lifetimes</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span>
                    <span class="n">begin_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="n">lifetime</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">end_date</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="n">lifetime</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">begin_date</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">ONEDAY</span><span class="p">))</span>

                <span class="c1"># Update our current set.</span>
                <span class="n">commodities</span> <span class="o">=</span> <span class="n">new_commodities</span>

    <span class="k">return</span> <span class="n">lifetimes</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.lifetimes.required_daily_prices" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">lifetimes</span><span class="o">.</span><span class="n">required_daily_prices</span><span class="p">(</span><span class="n">lifetimes_map</span><span class="p">,</span> <span class="n">date_last</span><span class="p">,</span> <span class="n">weekdays_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#beancount.ops.lifetimes.required_daily_prices" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Enumerate all the commodities and days where the price is required.</p>
<p>Given a map of lifetimes for a set of commodities, enumerate all the days
for each commodity where it is active. This can be used to connect to a
historical price fetcher routine to fill in missing price entries from an
existing ledger.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>lifetimes_map</strong> – A dict of currency to active intervals as returned by
get_commodity_lifetimes().</p></li>
            <li><p><strong>date_last</strong> – A datetime.date instance, the last date which we're interested in.</p></li>
            <li><p><strong>weekdays_only</strong> – Option to limit fetching to weekdays only.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>Tuples of (date, currency, cost-currency).</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/lifetimes.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">required_daily_prices</span><span class="p">(</span><span class="n">lifetimes_map</span><span class="p">,</span> <span class="n">date_last</span><span class="p">,</span> <span class="n">weekdays_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumerate all the commodities and days where the price is required.</span>

<span class="sd">    Given a map of lifetimes for a set of commodities, enumerate all the days</span>
<span class="sd">    for each commodity where it is active. This can be used to connect to a</span>
<span class="sd">    historical price fetcher routine to fill in missing price entries from an</span>
<span class="sd">    existing ledger.</span>

<span class="sd">    Args:</span>
<span class="sd">      lifetimes_map: A dict of currency to active intervals as returned by</span>
<span class="sd">        get_commodity_lifetimes().</span>
<span class="sd">      date_last: A datetime.date instance, the last date which we&#39;re interested in.</span>
<span class="sd">      weekdays_only: Option to limit fetching to weekdays only.</span>
<span class="sd">    Returns:</span>
<span class="sd">      Tuples of (date, currency, cost-currency).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">currency_pair</span><span class="p">,</span> <span class="n">intervals</span> <span class="ow">in</span> <span class="n">lifetimes_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">currency_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">date_begin</span><span class="p">,</span> <span class="n">date_end</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
            <span class="c1"># Find first Weekday starting on or before minimum date.</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">date_begin</span>
            <span class="k">if</span> <span class="n">weekdays_only</span><span class="p">:</span>
                <span class="n">diff_days</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">date_begin</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">diff_days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">date</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">diff_days</span><span class="p">)</span>

            <span class="c1"># Iterate over all weekdays.</span>
            <span class="k">if</span> <span class="n">date_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">date_end</span> <span class="o">=</span> <span class="n">date_last</span>
            <span class="k">while</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">date_end</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">date</span><span class="p">,</span> <span class="n">currency_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">currency_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">weekdays_only</span> <span class="ow">and</span> <span class="n">date</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">date</span> <span class="o">+=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">ONEDAY</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">date</span> <span class="o">+=</span> <span class="n">ONEDAY</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.lifetimes.required_weekly_prices" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">lifetimes</span><span class="o">.</span><span class="n">required_weekly_prices</span><span class="p">(</span><span class="n">lifetimes_map</span><span class="p">,</span> <span class="n">date_last</span><span class="p">)</span></code>


<a href="#beancount.ops.lifetimes.required_weekly_prices" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Enumerate all the commodities and Fridays where the price is required.</p>
<p>Given a map of lifetimes for a set of commodities, enumerate all the Fridays
for each commodity where it is active. This can be used to connect to a
historical price fetcher routine to fill in missing price entries from an
existing ledger.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>lifetimes_map</strong> – A dict of currency to active intervals as returned by
get_commodity_lifetimes().</p></li>
            <li><p><strong>date_last</strong> – A datetime.date instance, the last date which we're interested in.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>Tuples of (date, currency, cost-currency).</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/lifetimes.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">required_weekly_prices</span><span class="p">(</span><span class="n">lifetimes_map</span><span class="p">,</span> <span class="n">date_last</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumerate all the commodities and Fridays where the price is required.</span>

<span class="sd">    Given a map of lifetimes for a set of commodities, enumerate all the Fridays</span>
<span class="sd">    for each commodity where it is active. This can be used to connect to a</span>
<span class="sd">    historical price fetcher routine to fill in missing price entries from an</span>
<span class="sd">    existing ledger.</span>

<span class="sd">    Args:</span>
<span class="sd">      lifetimes_map: A dict of currency to active intervals as returned by</span>
<span class="sd">        get_commodity_lifetimes().</span>
<span class="sd">      date_last: A datetime.date instance, the last date which we&#39;re interested in.</span>
<span class="sd">    Returns:</span>
<span class="sd">      Tuples of (date, currency, cost-currency).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">currency_pair</span><span class="p">,</span> <span class="n">intervals</span> <span class="ow">in</span> <span class="n">lifetimes_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">currency_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">date_begin</span><span class="p">,</span> <span class="n">date_end</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
            <span class="c1"># Find first Friday before the minimum date.</span>
            <span class="n">diff_days</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">date_begin</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">diff_days</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">diff_days</span> <span class="o">-=</span> <span class="mi">7</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">date_begin</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">diff_days</span><span class="p">)</span>

            <span class="c1"># Iterate over all Fridays.</span>
            <span class="k">if</span> <span class="n">date_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">date_end</span> <span class="o">=</span> <span class="n">date_last</span>
            <span class="k">while</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">date_end</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">date</span><span class="p">,</span> <span class="n">currency_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">currency_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">date</span> <span class="o">+=</span> <span class="n">ONE_WEEK</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.lifetimes.trim_intervals" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">lifetimes</span><span class="o">.</span><span class="n">trim_intervals</span><span class="p">(</span><span class="n">intervals</span><span class="p">,</span> <span class="n">trim_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trim_end</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#beancount.ops.lifetimes.trim_intervals" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Trim a list of date pairs to be within a start and end date.
Useful in update-style price fetching.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>intervals</strong> – A list of pairs of datetime.date instances</p></li>
            <li><p><strong>trim_start</strong> – An inclusive starting date.</p></li>
            <li><p><strong>trim_end</strong> – An exclusive starting date.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of new intervals (pairs of (date, date)).</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/lifetimes.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">trim_intervals</span><span class="p">(</span><span class="n">intervals</span><span class="p">,</span> <span class="n">trim_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trim_end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Trim a list of date pairs to be within a start and end date.</span>
<span class="sd">    Useful in update-style price fetching.</span>

<span class="sd">    Args:</span>
<span class="sd">      intervals: A list of pairs of datetime.date instances</span>
<span class="sd">      trim_start: An inclusive starting date.</span>
<span class="sd">      trim_end: An exclusive starting date.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new intervals (pairs of (date, date)).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_intervals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">iter_intervals</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">trim_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">trim_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">trim_end</span> <span class="o">&lt;</span> <span class="n">trim_start</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trim end date is before start date&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">date_begin</span><span class="p">,</span> <span class="n">date_end</span> <span class="ow">in</span> <span class="n">iter_intervals</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">trim_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">trim_start</span> <span class="o">&gt;</span> <span class="n">date_begin</span><span class="p">:</span>
            <span class="n">date_begin</span> <span class="o">=</span> <span class="n">trim_start</span>
        <span class="k">if</span> <span class="n">trim_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">date_end</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">trim_end</span> <span class="o">&lt;</span> <span class="n">date_end</span><span class="p">:</span>
                <span class="n">date_end</span> <span class="o">=</span> <span class="n">trim_end</span>

        <span class="k">if</span> <span class="n">date_end</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">date_begin</span> <span class="o">&lt;=</span> <span class="n">date_end</span><span class="p">:</span>
            <span class="n">new_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">date_begin</span><span class="p">,</span> <span class="n">date_end</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_intervals</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="beancount.ops.pad" class="doc doc-heading">
        <code>beancount.ops.pad</code>



<a href="#beancount.ops.pad" class="headerlink" title="Permanent link"></a></h2>

    <div class="doc doc-contents ">

      <p>Automatic padding of gaps between entries.</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-class">



<h3 id="beancount.ops.pad.PadError" class="doc doc-heading">
        <code>
beancount.ops.pad.PadError            (<span title="tuple">tuple</span>)
        </code>



<a href="#beancount.ops.pad.PadError" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>PadError(source, message, entry)</p>




  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="beancount.ops.pad.PadError.__getnewargs__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">pad</span><span class="o">.</span><span class="n">PadError</span><span class="o">.</span><span class="n">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#beancount.ops.pad.PadError.__getnewargs__" class="headerlink" title="Permanent link"></a></h4>

    <div class="doc doc-contents ">

      <p>Return self as a plain tuple.  Used by copy and pickle.</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/pad.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">&#39;Return self as a plain tuple.  Used by copy and pickle.&#39;</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="beancount.ops.pad.PadError.__new__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">pad</span><span class="o">.</span><span class="n">PadError</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#beancount.ops.pad.PadError.__new__" class="headerlink" title="Permanent link"></a></h4>

    <div class="doc doc-contents ">

      <p>Create new instance of PadError(source, message, entry)</p>

    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="beancount.ops.pad.PadError.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">pad</span><span class="o">.</span><span class="n">PadError</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#beancount.ops.pad.PadError.__repr__" class="headerlink" title="Permanent link"></a></h4>

    <div class="doc doc-contents ">

      <p>Return a nicely formatted representation string</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/pad.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">&#39;Return a nicely formatted representation string&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.pad.pad" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">pad</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.pad.pad" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Insert transaction entries for to fulfill a subsequent balance check.</p>
<p>Synthesize and insert Transaction entries right after Pad entries in order
to fulfill checks in the padded accounts. Returns a new list of entries.
Note that this doesn't pad across parent-child relationships, it is a very
simple kind of pad. (I have found this to be sufficient in practice, and
simpler to implement and understand.)</p>
<p>Furthermore, this pads for a single currency only, that is, balance checks
are specified only for one currency at a time, and pads will only be
inserted for those currencies.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>options_map</strong> – A parser options dict.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A new list of directives, with Pad entries inserted, and a list of new
errors produced.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/pad.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Insert transaction entries for to fulfill a subsequent balance check.</span>

<span class="sd">    Synthesize and insert Transaction entries right after Pad entries in order</span>
<span class="sd">    to fulfill checks in the padded accounts. Returns a new list of entries.</span>
<span class="sd">    Note that this doesn&#39;t pad across parent-child relationships, it is a very</span>
<span class="sd">    simple kind of pad. (I have found this to be sufficient in practice, and</span>
<span class="sd">    simpler to implement and understand.)</span>

<span class="sd">    Furthermore, this pads for a single currency only, that is, balance checks</span>
<span class="sd">    are specified only for one currency at a time, and pads will only be</span>
<span class="sd">    inserted for those currencies.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      options_map: A parser options dict.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new list of directives, with Pad entries inserted, and a list of new</span>
<span class="sd">      errors produced.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pad_errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Find all the pad entries and group them by account.</span>
    <span class="n">pads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">misc_utils</span><span class="o">.</span><span class="n">filter_type</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Pad</span><span class="p">))</span>
    <span class="n">pad_dict</span> <span class="o">=</span> <span class="n">misc_utils</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">pads</span><span class="p">)</span>

    <span class="c1"># Partially realize the postings, so we can iterate them by account.</span>
    <span class="n">by_account</span> <span class="o">=</span> <span class="n">realization</span><span class="o">.</span><span class="n">postings_by_account</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c1"># A dict of pad -&gt; list of entries to be inserted.</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">{</span><span class="nb">id</span><span class="p">(</span><span class="n">pad</span><span class="p">):</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">pad</span> <span class="ow">in</span> <span class="n">pads</span><span class="p">}</span>

    <span class="c1"># Process each account that has a padding group.</span>
    <span class="k">for</span> <span class="n">account_</span><span class="p">,</span> <span class="n">pad_list</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pad_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c1"># Last encountered / currency active pad entry.</span>
        <span class="n">active_pad</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Gather all the postings for the account and its children.</span>
        <span class="n">postings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">is_child</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">parent_matcher</span><span class="p">(</span><span class="n">account_</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item_account</span><span class="p">,</span> <span class="n">item_postings</span> <span class="ow">in</span> <span class="n">by_account</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">is_child</span><span class="p">(</span><span class="n">item_account</span><span class="p">):</span>
                <span class="n">postings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item_postings</span><span class="p">)</span>
        <span class="n">postings</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">posting_sortkey</span><span class="p">)</span>

        <span class="c1"># A set of currencies already padded so far in this account.</span>
        <span class="n">padded_lots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">pad_balance</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">postings</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">TxnPosting</span><span class="p">):</span>
                <span class="c1"># This is a transaction; update the running balance for this</span>
                <span class="c1"># account.</span>
                <span class="n">pad_balance</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">posting</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Pad</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">account</span> <span class="o">==</span> <span class="n">account_</span><span class="p">:</span>
                    <span class="c1"># Mark this newly encountered pad as active and allow all lots</span>
                    <span class="c1"># to be padded heretofore.</span>
                    <span class="n">active_pad</span> <span class="o">=</span> <span class="n">entry</span>
                    <span class="n">padded_lots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Balance</span><span class="p">):</span>
                <span class="n">check_amount</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">amount</span>

                <span class="c1"># Compare the current balance amount to the expected one from</span>
                <span class="c1"># the check entry. IMPORTANT: You need to understand that this</span>
                <span class="c1"># does not check a single position, but rather checks that the</span>
                <span class="c1"># total amount for a particular currency (which itself is</span>
                <span class="c1"># distinct from the cost).</span>
                <span class="n">balance_amount</span> <span class="o">=</span> <span class="n">pad_balance</span><span class="o">.</span><span class="n">get_currency_units</span><span class="p">(</span><span class="n">check_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
                <span class="n">diff_amount</span> <span class="o">=</span> <span class="n">amount</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">balance_amount</span><span class="p">,</span> <span class="n">check_amount</span><span class="p">)</span>

                <span class="c1"># Use the specified tolerance or automatically infer it.</span>
                <span class="n">tolerance</span> <span class="o">=</span> <span class="n">balance</span><span class="o">.</span><span class="n">get_balance_tolerance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff_amount</span><span class="o">.</span><span class="n">number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
                    <span class="c1"># The check fails; we need to pad.</span>

                    <span class="c1"># Pad only if pad entry is active and we haven&#39;t already</span>
                    <span class="c1"># padded that lot since it was last encountered.</span>
                    <span class="k">if</span> <span class="n">active_pad</span> <span class="ow">and</span> <span class="p">(</span><span class="n">check_amount</span><span class="o">.</span><span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">padded_lots</span><span class="p">):</span>
                        <span class="c1"># Note: we decide that it&#39;s an error to try to pad</span>
                        <span class="c1"># positions at cost; we check here that all the existing</span>
                        <span class="c1"># positions with that currency have no cost.</span>
                        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">pos</span>
                            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">pad_balance</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">check_amount</span><span class="o">.</span><span class="n">currency</span>
                        <span class="p">]</span>
                        <span class="k">for</span> <span class="n">position_</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">position_</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">pad_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">PadError</span><span class="p">(</span>
                                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                        <span class="p">(</span>
                                            <span class="s2">&quot;Attempt to pad an entry with cost for &quot;</span>
                                            <span class="s2">&quot;balance: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pad_balance</span><span class="p">)</span>
                                        <span class="p">),</span>
                                        <span class="n">active_pad</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>

                        <span class="c1"># Thus our padding lot is without cost by default.</span>
                        <span class="n">diff_position</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">from_amounts</span><span class="p">(</span>
                            <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span>
                                <span class="n">check_amount</span><span class="o">.</span><span class="n">number</span> <span class="o">-</span> <span class="n">balance_amount</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                <span class="n">check_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                        <span class="c1"># Synthesize a new transaction entry for the difference.</span>
                        <span class="n">narration</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;(Padding inserted for Balance of </span><span class="si">{}</span><span class="s2"> for &quot;</span> <span class="s2">&quot;difference </span><span class="si">{}</span><span class="s2">)&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_amount</span><span class="p">,</span> <span class="n">diff_position</span><span class="p">)</span>
                        <span class="n">new_entry</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">(</span>
                            <span class="n">active_pad</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                            <span class="n">active_pad</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                            <span class="n">flags</span><span class="o">.</span><span class="n">FLAG_PADDING</span><span class="p">,</span>
                            <span class="kc">None</span><span class="p">,</span>
                            <span class="n">narration</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span>
                            <span class="p">[],</span>
                        <span class="p">)</span>

                        <span class="n">new_entry</span><span class="o">.</span><span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span>
                                <span class="n">active_pad</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                                <span class="n">diff_position</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                                <span class="n">diff_position</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                                <span class="kc">None</span><span class="p">,</span>
                                <span class="kc">None</span><span class="p">,</span>
                                <span class="p">{},</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">neg_diff_position</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff_position</span>
                        <span class="n">new_entry</span><span class="o">.</span><span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span>
                                <span class="n">active_pad</span><span class="o">.</span><span class="n">source_account</span><span class="p">,</span>
                                <span class="n">neg_diff_position</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                                <span class="n">neg_diff_position</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                                <span class="kc">None</span><span class="p">,</span>
                                <span class="kc">None</span><span class="p">,</span>
                                <span class="p">{},</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                        <span class="c1"># Save it for later insertion after the active pad.</span>
                        <span class="n">new_entries</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">active_pad</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_entry</span><span class="p">)</span>

                        <span class="c1"># Fixup the running balance.</span>
                        <span class="n">pos</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pad_balance</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">diff_position</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pos</span><span class="o">.</span><span class="n">is_negative_at_cost</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;Position held at cost goes negative: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                            <span class="p">)</span>

                <span class="c1"># Mark this lot as padded. Further checks should not pad this lot.</span>
                <span class="n">padded_lots</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">check_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>

    <span class="c1"># Insert the newly created entries right after the pad entries that created them.</span>
    <span class="n">padded_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="n">padded_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Pad</span><span class="p">):</span>
            <span class="n">entry_list</span> <span class="o">=</span> <span class="n">new_entries</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">entry</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">entry_list</span><span class="p">:</span>
                <span class="n">padded_entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">entry_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Generate errors on unused pad entries.</span>
                <span class="n">pad_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PadError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="s2">&quot;Unused Pad entry&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">padded_entries</span><span class="p">,</span> <span class="n">pad_errors</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="beancount.ops.summarize" class="doc doc-heading">
        <code>beancount.ops.summarize</code>



<a href="#beancount.ops.summarize" class="headerlink" title="Permanent link"></a></h2>

    <div class="doc doc-contents ">

      <p>Summarization of entries.</p>
<p>This code is used to summarize a sequence of entries (e.g. during a time period)
into a few "opening balance" entries. This is when computing a balance sheet for
a specific time period: we don't want to see the entries from before some period
of time, so we fold them into a single transaction per account that has the sum
total amount of that account.</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.balance_by_account" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">balance_by_account</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compress_unbooked</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.balance_by_account" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Sum up the balance per account for all entries strictly before 'date'.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>date</strong> – An optional datetime.date instance. If provided, stop accumulating
on and after this date. This is useful for summarization before a
specific date.</p></li>
            <li><p><strong>compress_unbooked</strong> – For accounts that have a booking method of NONE,
compress their positions into a single average position. This can be
used when you export the full list of positions, because those accounts
will have a myriad of small positions from fees at negative cost and
what-not.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A pair of a dict of account string to instance Inventory (the balance of
this account before the given date), and the index in the list of entries
where the date was encountered. If all entries are located before the
cutoff date, an index one beyond the last entry is returned.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">balance_by_account</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compress_unbooked</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sum up the balance per account for all entries strictly before &#39;date&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: An optional datetime.date instance. If provided, stop accumulating</span>
<span class="sd">        on and after this date. This is useful for summarization before a</span>
<span class="sd">        specific date.</span>
<span class="sd">      compress_unbooked: For accounts that have a booking method of NONE,</span>
<span class="sd">        compress their positions into a single average position. This can be</span>
<span class="sd">        used when you export the full list of positions, because those accounts</span>
<span class="sd">        will have a myriad of small positions from fees at negative cost and</span>
<span class="sd">        what-not.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A pair of a dict of account string to instance Inventory (the balance of</span>
<span class="sd">      this account before the given date), and the index in the list of entries</span>
<span class="sd">      where the date was encountered. If all entries are located before the</span>
<span class="sd">      cutoff date, an index one beyond the last entry is returned.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">balances</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
                <span class="n">account_balance</span> <span class="o">=</span> <span class="n">balances</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>

                <span class="c1"># Note: We must allow negative lots at cost, because this may be</span>
                <span class="c1"># used to reduce a filtered list of entries which may not</span>
                <span class="c1"># include the entries necessary to keep units at cost always</span>
                <span class="c1"># above zero. The only summation that is guaranteed to be above</span>
                <span class="c1"># zero is if all the entries are being summed together, no</span>
                <span class="c1"># entries are filtered, at least for a particular account&#39;s</span>
                <span class="c1"># postings.</span>
                <span class="n">account_balance</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c1"># If the account has &quot;NONE&quot; booking method, merge all its postings</span>
    <span class="c1"># together in order to obtain an accurate cost basis and balance of</span>
    <span class="c1"># units.</span>
    <span class="c1">#</span>
    <span class="c1"># (This is a complex issue.) If you accrued positions without having them</span>
    <span class="c1"># booked properly against existing cost bases, you have not properly accounted</span>
    <span class="c1"># for the profit/loss to other postings. This means that the resulting</span>
    <span class="c1"># profit/loss is merged in the cost basis of the positive and negative</span>
    <span class="c1"># postings.</span>
    <span class="k">if</span> <span class="n">compress_unbooked</span><span class="p">:</span>
        <span class="n">oc_map</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_account_open_close</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="n">accounts_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">account</span><span class="p">:</span> <span class="n">dopen</span> <span class="k">for</span> <span class="n">account</span><span class="p">,</span> <span class="p">(</span><span class="n">dopen</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">oc_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">for</span> <span class="n">account</span><span class="p">,</span> <span class="n">balance</span> <span class="ow">in</span> <span class="n">balances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dopen</span> <span class="o">=</span> <span class="n">accounts_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dopen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dopen</span><span class="o">.</span><span class="n">booking</span> <span class="ow">is</span> <span class="n">data</span><span class="o">.</span><span class="n">Booking</span><span class="o">.</span><span class="n">NONE</span><span class="p">:</span>
                <span class="n">average_balance</span> <span class="o">=</span> <span class="n">balance</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
                <span class="n">balances</span><span class="p">[</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">(</span><span class="n">pos</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">average_balance</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">balances</span><span class="p">,</span> <span class="n">index</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.cap" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">cap</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.cap" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Transfer net income to equity and insert a final conversion entry.</p>
<p>This is used to move and nullify balances from the income and expense
accounts to an equity account in order to draw up a balance sheet with a
balance of precisely zero.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>account_types</strong> – An instance of AccountTypes.</p></li>
            <li><p><strong>conversion_currency</strong> – A string, the transfer currency to use for zero prices
on the conversion entry.</p></li>
            <li><p><strong>account_earnings</strong> – A string, the name of the equity account to transfer
final balances of the income and expense accounts to.</p></li>
            <li><p><strong>account_conversions</strong> – A string, the name of the equity account to use as
the source for currency conversions.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A modified list of entries, with the income and expense accounts
transferred.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">cap</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transfer net income to equity and insert a final conversion entry.</span>

<span class="sd">    This is used to move and nullify balances from the income and expense</span>
<span class="sd">    accounts to an equity account in order to draw up a balance sheet with a</span>
<span class="sd">    balance of precisely zero.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      account_types: An instance of AccountTypes.</span>
<span class="sd">      conversion_currency: A string, the transfer currency to use for zero prices</span>
<span class="sd">        on the conversion entry.</span>
<span class="sd">      account_earnings: A string, the name of the equity account to transfer</span>
<span class="sd">        final balances of the income and expense accounts to.</span>
<span class="sd">      account_conversions: A string, the name of the equity account to use as</span>
<span class="sd">        the source for currency conversions.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A modified list of entries, with the income and expense accounts</span>
<span class="sd">      transferred.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Transfer the balances of income and expense accounts as earnings / net</span>
    <span class="c1"># income.</span>
    <span class="n">income_statement_account_pred</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">account</span><span class="p">:</span> <span class="n">is_income_statement_account</span><span class="p">(</span>
        <span class="n">account</span><span class="p">,</span> <span class="n">account_types</span>
    <span class="p">)</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">transfer_balances</span><span class="p">(</span>
        <span class="n">entries</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">income_statement_account_pred</span><span class="p">,</span> <span class="n">account_earnings</span>
    <span class="p">)</span>

    <span class="c1"># Insert final conversion entries.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entries</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.cap_opt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">cap_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.cap_opt" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Close by getting all the parameters from an options map.</p>
<p>See cap() for details.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – See cap().</p></li>
            <li><p><strong>options_map</strong> – A parser's option_map.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>Same as close().</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">cap_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close by getting all the parameters from an options map.</span>

<span class="sd">    See cap() for details.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: See cap().</span>
<span class="sd">      options_map: A parser&#39;s option_map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      Same as close().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">account_types</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">current_accounts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_current_accounts</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">conversion_currency</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s2">&quot;conversion_currency&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cap</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="o">*</span><span class="n">current_accounts</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.clamp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">begin_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.clamp" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Filter entries to include only those during a specified time period.</p>
<p>Firstly, this method will transfer all balances for the income and expense
accounts occurring before the given period begin date to the
'account_earnings' account (earnings before the period, or "retained
earnings") and summarize all of the transactions before that date against
the 'account_opening' account (usually "opening balances"). The resulting
income and expense accounts should have no transactions (since their
balances have been transferred out and summarization of zero balances should
not add any transactions).</p>
<p>Secondly, all the entries after the period end date will be truncated and a
conversion entry will be added for the resulting transactions that reflect
changes occurring between the beginning and end of the exercise period. The
resulting balance of all account should be empty.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directive tuples.</p></li>
            <li><p><strong>begin_date</strong> – A datetime.date instance, the beginning of the period.</p></li>
            <li><p><strong>end_date</strong> – A datetime.date instance, one day beyond the end of the period.</p></li>
            <li><p><strong>account_types</strong> – An instance of AccountTypes.</p></li>
            <li><p><strong>conversion_currency</strong> – A string, the transfer currency to use for zero prices
on the conversion entry.</p></li>
            <li><p><strong>account_earnings</strong> – A string, the name of the account to transfer
previous earnings from the income statement accounts to the balance
sheet.</p></li>
            <li><p><strong>account_opening</strong> – A string, the name of the account in equity
to transfer previous balances from, in order to initialize account
balances at the beginning of the period. This is typically called an
opening balances account.</p></li>
            <li><p><strong>account_conversions</strong> – A string, the name of the equity account to
book currency conversions against.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A new list of entries is returned, and the index that points to the first
original transaction after the beginning date of the period. This index
can be used to generate the opening balances report, which is a balance
sheet fed with only the summarized entries.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">clamp</span><span class="p">(</span>
    <span class="n">entries</span><span class="p">,</span>
    <span class="n">begin_date</span><span class="p">,</span>
    <span class="n">end_date</span><span class="p">,</span>
    <span class="n">account_types</span><span class="p">,</span>
    <span class="n">conversion_currency</span><span class="p">,</span>
    <span class="n">account_earnings</span><span class="p">,</span>
    <span class="n">account_opening</span><span class="p">,</span>
    <span class="n">account_conversions</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter entries to include only those during a specified time period.</span>

<span class="sd">    Firstly, this method will transfer all balances for the income and expense</span>
<span class="sd">    accounts occurring before the given period begin date to the</span>
<span class="sd">    &#39;account_earnings&#39; account (earnings before the period, or &quot;retained</span>
<span class="sd">    earnings&quot;) and summarize all of the transactions before that date against</span>
<span class="sd">    the &#39;account_opening&#39; account (usually &quot;opening balances&quot;). The resulting</span>
<span class="sd">    income and expense accounts should have no transactions (since their</span>
<span class="sd">    balances have been transferred out and summarization of zero balances should</span>
<span class="sd">    not add any transactions).</span>

<span class="sd">    Secondly, all the entries after the period end date will be truncated and a</span>
<span class="sd">    conversion entry will be added for the resulting transactions that reflect</span>
<span class="sd">    changes occurring between the beginning and end of the exercise period. The</span>
<span class="sd">    resulting balance of all account should be empty.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directive tuples.</span>
<span class="sd">      begin_date: A datetime.date instance, the beginning of the period.</span>
<span class="sd">      end_date: A datetime.date instance, one day beyond the end of the period.</span>
<span class="sd">      account_types: An instance of AccountTypes.</span>
<span class="sd">      conversion_currency: A string, the transfer currency to use for zero prices</span>
<span class="sd">        on the conversion entry.</span>
<span class="sd">      account_earnings: A string, the name of the account to transfer</span>
<span class="sd">        previous earnings from the income statement accounts to the balance</span>
<span class="sd">        sheet.</span>
<span class="sd">      account_opening: A string, the name of the account in equity</span>
<span class="sd">        to transfer previous balances from, in order to initialize account</span>
<span class="sd">        balances at the beginning of the period. This is typically called an</span>
<span class="sd">        opening balances account.</span>
<span class="sd">      account_conversions: A string, the name of the equity account to</span>
<span class="sd">        book currency conversions against.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new list of entries is returned, and the index that points to the first</span>
<span class="sd">      original transaction after the beginning date of the period. This index</span>
<span class="sd">      can be used to generate the opening balances report, which is a balance</span>
<span class="sd">      sheet fed with only the summarized entries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Transfer income and expenses before the period to equity.</span>
    <span class="n">income_statement_account_pred</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">account</span><span class="p">:</span> <span class="n">is_income_statement_account</span><span class="p">(</span>
        <span class="n">account</span><span class="p">,</span> <span class="n">account_types</span>
    <span class="p">)</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">transfer_balances</span><span class="p">(</span>
        <span class="n">entries</span><span class="p">,</span> <span class="n">begin_date</span><span class="p">,</span> <span class="n">income_statement_account_pred</span><span class="p">,</span> <span class="n">account_earnings</span>
    <span class="p">)</span>

    <span class="c1"># Summarize all the previous balances, after transferring the income and</span>
    <span class="c1"># expense balances, so all entries for those accounts before the begin date</span>
    <span class="c1"># should now disappear.</span>
    <span class="n">entries</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">begin_date</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">)</span>

    <span class="c1"># Truncate the entries after this.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">truncate</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

    <span class="c1"># Insert conversion entries.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">index</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.clamp_opt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">clamp_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">begin_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.clamp_opt" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Clamp by getting all the parameters from an options map.</p>
<p>See clamp() for details.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – See clamp().</p></li>
            <li><p><strong>begin_date</strong> – See clamp().</p></li>
            <li><p><strong>end_date</strong> – See clamp().</p></li>
            <li><p><strong>options_map</strong> – A parser's option_map.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>Same as clamp().</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">clamp_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">begin_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clamp by getting all the parameters from an options map.</span>

<span class="sd">    See clamp() for details.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: See clamp().</span>
<span class="sd">      begin_date: See clamp().</span>
<span class="sd">      end_date: See clamp().</span>
<span class="sd">      options_map: A parser&#39;s option_map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      Same as clamp().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">account_types</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">previous_earnings</span><span class="p">,</span> <span class="n">previous_balances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_previous_accounts</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">current_conversions</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_current_accounts</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>

    <span class="n">conversion_currency</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s2">&quot;conversion_currency&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">clamp</span><span class="p">(</span>
        <span class="n">entries</span><span class="p">,</span>
        <span class="n">begin_date</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">,</span>
        <span class="n">account_types</span><span class="p">,</span>
        <span class="n">conversion_currency</span><span class="p">,</span>
        <span class="n">previous_earnings</span><span class="p">,</span>
        <span class="n">previous_balances</span><span class="p">,</span>
        <span class="n">current_conversions</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.clear" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.clear" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Transfer income and expenses balances at the given date to the equity accounts.</p>
<p>This method insert entries to zero out balances on income and expenses
accounts by transferring them to an equity account.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directive tuples.</p></li>
            <li><p><strong>date</strong> – A datetime.date instance, one day beyond the end of the period. This
date can be optionally left to None in order to close at the end of the
list of entries.</p></li>
            <li><p><strong>account_types</strong> – An instance of AccountTypes.</p></li>
            <li><p><strong>account_earnings</strong> – A string, the name of the account to transfer
previous earnings from the income statement accounts to the balance
sheet.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A new list of entries is returned, and the index that points to one before
the last original transaction before the transfers.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transfer income and expenses balances at the given date to the equity accounts.</span>

<span class="sd">    This method insert entries to zero out balances on income and expenses</span>
<span class="sd">    accounts by transferring them to an equity account.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directive tuples.</span>
<span class="sd">      date: A datetime.date instance, one day beyond the end of the period. This</span>
<span class="sd">        date can be optionally left to None in order to close at the end of the</span>
<span class="sd">        list of entries.</span>
<span class="sd">      account_types: An instance of AccountTypes.</span>
<span class="sd">      account_earnings: A string, the name of the account to transfer</span>
<span class="sd">        previous earnings from the income statement accounts to the balance</span>
<span class="sd">        sheet.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new list of entries is returned, and the index that points to one before</span>
<span class="sd">      the last original transaction before the transfers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c1"># Transfer income and expenses before the period to equity.</span>
    <span class="n">income_statement_account_pred</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">account</span><span class="p">:</span> <span class="n">is_income_statement_account</span><span class="p">(</span>
        <span class="n">account</span><span class="p">,</span> <span class="n">account_types</span>
    <span class="p">)</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="n">transfer_balances</span><span class="p">(</span>
        <span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">income_statement_account_pred</span><span class="p">,</span> <span class="n">account_earnings</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">index</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.clear_opt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">clear_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.clear_opt" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Convenience function to clear() using an options map.</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">clear_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience function to clear() using an options map.&quot;&quot;&quot;</span>
    <span class="n">account_types</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">current_accounts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_current_accounts</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clear</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">current_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.close" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.close" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Truncate entries that occur after a particular date and ensure balance.</p>
<p>This method essentially removes entries after a date. It truncates the
future. To do so, it will</p>
<ol>
<li>
<p>Remove all entries which occur after 'date', if given.</p>
</li>
<li>
<p>Insert conversion transactions at the end of the list of entries to
   ensure that the total balance of all postings sums up to empty.</p>
</li>
</ol>
<p>The result is a list of entries with a total balance of zero, with possibly
non-zero balances for the income/expense accounts. To produce a final
balance sheet, use transfer() to move the net income to the equity accounts.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directive tuples.</p></li>
            <li><p><strong>date</strong> – A datetime.date instance, one day beyond the end of the period. This
date can be optionally left to None in order to close at the end of the
list of entries.</p></li>
            <li><p><strong>conversion_currency</strong> – A string, the transfer currency to use for zero prices
on the conversion entry.</p></li>
            <li><p><strong>account_conversions</strong> – A string, the name of the equity account to
book currency conversions against.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A new list of entries is returned, and the index that points to one beyond
the last original transaction that was provided. Further entries may have
been inserted to normalize conversions and ensure the total balance sums
to zero.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Truncate entries that occur after a particular date and ensure balance.</span>

<span class="sd">    This method essentially removes entries after a date. It truncates the</span>
<span class="sd">    future. To do so, it will</span>

<span class="sd">    1. Remove all entries which occur after &#39;date&#39;, if given.</span>

<span class="sd">    2. Insert conversion transactions at the end of the list of entries to</span>
<span class="sd">       ensure that the total balance of all postings sums up to empty.</span>

<span class="sd">    The result is a list of entries with a total balance of zero, with possibly</span>
<span class="sd">    non-zero balances for the income/expense accounts. To produce a final</span>
<span class="sd">    balance sheet, use transfer() to move the net income to the equity accounts.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directive tuples.</span>
<span class="sd">      date: A datetime.date instance, one day beyond the end of the period. This</span>
<span class="sd">        date can be optionally left to None in order to close at the end of the</span>
<span class="sd">        list of entries.</span>
<span class="sd">      conversion_currency: A string, the transfer currency to use for zero prices</span>
<span class="sd">        on the conversion entry.</span>
<span class="sd">      account_conversions: A string, the name of the equity account to</span>
<span class="sd">        book currency conversions against.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new list of entries is returned, and the index that points to one beyond</span>
<span class="sd">      the last original transaction that was provided. Further entries may have</span>
<span class="sd">      been inserted to normalize conversions and ensure the total balance sums</span>
<span class="sd">      to zero.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Truncate the entries after the date, if a date has been provided.</span>
    <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">truncate</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># Keep an index to the truncated list of entries (before conversions).</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c1"># Insert a conversions entry to ensure the total balance of all accounts is</span>
    <span class="c1"># flush zero.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">index</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.close_opt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">close_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.close_opt" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Convenience function to close() using an options map.</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">close_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience function to close() using an options map.&quot;&quot;&quot;</span>
    <span class="n">conversion_currency</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s2">&quot;conversion_currency&quot;</span><span class="p">]</span>
    <span class="n">current_accounts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_current_accounts</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">close</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">current_accounts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.conversions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">conversion_account</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.conversions" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Insert a conversion entry at date 'date' at the given account.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of entries.</p></li>
            <li><p><strong>conversion_account</strong> – A string, the account to book against.</p></li>
            <li><p><strong>conversion_currency</strong> – A string, the transfer currency to use for zero prices
on the conversion entry.</p></li>
            <li><p><strong>date</strong> – The date before which to insert the conversion entry. The new
entry will be inserted as the last entry of the date just previous
to this date.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A modified list of entries.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">conversion_account</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Insert a conversion entry at date &#39;date&#39; at the given account.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of entries.</span>
<span class="sd">      conversion_account: A string, the account to book against.</span>
<span class="sd">      conversion_currency: A string, the transfer currency to use for zero prices</span>
<span class="sd">        on the conversion entry.</span>
<span class="sd">      date: The date before which to insert the conversion entry. The new</span>
<span class="sd">        entry will be inserted as the last entry of the date just previous</span>
<span class="sd">        to this date.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A modified list of entries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute the balance at the given date.</span>
    <span class="n">conversion_balance</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">compute_entries_balance</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>

    <span class="c1"># Early exit if there is nothing to do.</span>
    <span class="n">conversion_cost_balance</span> <span class="o">=</span> <span class="n">conversion_balance</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">get_cost</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">conversion_cost_balance</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">entries</span>

    <span class="c1"># Calculate the index and the date for the new entry. We want to store it as</span>
    <span class="c1"># the last transaction of the day before.</span>
    <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">bisect_key</span><span class="o">.</span><span class="n">bisect_left_with_key</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">last_date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="n">last_date</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span>

    <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s2">&quot;&lt;conversions&gt;&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">narration</span> <span class="o">=</span> <span class="s2">&quot;Conversion for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conversion_balance</span><span class="p">)</span>
    <span class="n">conversion_entry</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">(</span>
        <span class="n">meta</span><span class="p">,</span>
        <span class="n">last_date</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">.</span><span class="n">FLAG_CONVERSIONS</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">narration</span><span class="p">,</span>
        <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span>
        <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span>
        <span class="p">[],</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">conversion_cost_balance</span><span class="o">.</span><span class="n">get_positions</span><span class="p">():</span>
        <span class="c1"># Important note: Set the cost to zero here to maintain the balance</span>
        <span class="c1"># invariant. (This is the only single place we cheat on the balance rule</span>
        <span class="c1"># in the entire system and this is necessary; see documentation on</span>
        <span class="c1"># Conversions.)</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">ZERO</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">)</span>
        <span class="n">neg_pos</span> <span class="o">=</span> <span class="o">-</span><span class="n">position</span>
        <span class="n">conversion_entry</span><span class="o">.</span><span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">conversion_account</span><span class="p">,</span> <span class="n">neg_pos</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">neg_pos</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Make a copy of the list of entries and insert the new transaction into it.</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="n">new_entries</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">conversion_entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.create_entries_from_balances" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">create_entries_from_balances</span><span class="p">(</span><span class="n">balances</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">source_account</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">narration_template</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.create_entries_from_balances" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>"Create a list of entries from a dict of balances.</p>
<p>This method creates a list of new entries to transfer the amounts in the
'balances' dict to/from another account specified in 'source_account'.</p>
<p>The balancing posting is created with the equivalent at cost. In other
words, if you attempt to balance 10 HOOL {500 USD}, this will synthesize a
posting with this position on one leg, and with 5000 USD on the
'source_account' leg.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>balances</strong> – A dict of account name strings to Inventory instances.</p></li>
            <li><p><strong>date</strong> – A datetime.date object, the date at which to create the transaction.</p></li>
            <li><p><strong>source_account</strong> – A string, the name of the account to pull the balances
from. This is the magician's hat to pull the rabbit from.</p></li>
            <li><p><strong>direction</strong> – If 'direction' is True, the new entries transfer TO the
balances account from the source account; otherwise the new entries
transfer FROM the balances into the source account.</p></li>
            <li><p><strong>meta</strong> – A dict to use as metadata for the transactions.</p></li>
            <li><p><strong>flag</strong> – A string, the flag to use for the transactions.</p></li>
            <li><p><strong>narration_template</strong> – A format string for creating the narration. It is
formatted with 'account' and 'date' replacement variables.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of newly synthesizes Transaction entries.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_entries_from_balances</span><span class="p">(</span>
    <span class="n">balances</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">source_account</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">narration_template</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; &quot;Create a list of entries from a dict of balances.</span>

<span class="sd">    This method creates a list of new entries to transfer the amounts in the</span>
<span class="sd">    &#39;balances&#39; dict to/from another account specified in &#39;source_account&#39;.</span>

<span class="sd">    The balancing posting is created with the equivalent at cost. In other</span>
<span class="sd">    words, if you attempt to balance 10 HOOL {500 USD}, this will synthesize a</span>
<span class="sd">    posting with this position on one leg, and with 5000 USD on the</span>
<span class="sd">    &#39;source_account&#39; leg.</span>

<span class="sd">    Args:</span>
<span class="sd">      balances: A dict of account name strings to Inventory instances.</span>
<span class="sd">      date: A datetime.date object, the date at which to create the transaction.</span>
<span class="sd">      source_account: A string, the name of the account to pull the balances</span>
<span class="sd">        from. This is the magician&#39;s hat to pull the rabbit from.</span>
<span class="sd">      direction: If &#39;direction&#39; is True, the new entries transfer TO the</span>
<span class="sd">        balances account from the source account; otherwise the new entries</span>
<span class="sd">        transfer FROM the balances into the source account.</span>
<span class="sd">      meta: A dict to use as metadata for the transactions.</span>
<span class="sd">      flag: A string, the flag to use for the transactions.</span>
<span class="sd">      narration_template: A format string for creating the narration. It is</span>
<span class="sd">        formatted with &#39;account&#39; and &#39;date&#39; replacement variables.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of newly synthesizes Transaction entries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">account</span><span class="p">,</span> <span class="n">account_balance</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">balances</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c1"># Don&#39;t create new entries where there is no balance.</span>
        <span class="k">if</span> <span class="n">account_balance</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">continue</span>

        <span class="n">narration</span> <span class="o">=</span> <span class="n">narration_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account</span><span class="o">=</span><span class="n">account</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">direction</span><span class="p">:</span>
            <span class="n">account_balance</span> <span class="o">=</span> <span class="o">-</span><span class="n">account_balance</span>

        <span class="n">postings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_entry</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">(</span>
            <span class="n">meta</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">narration</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="n">postings</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">account_balance</span><span class="o">.</span><span class="n">get_positions</span><span class="p">():</span>
            <span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="o">-</span><span class="n">convert</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
            <span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">source_account</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.get_open_entries" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">get_open_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.get_open_entries" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Gather the list of active Open entries at date.</p>
<p>This returns the list of Open entries that have not been closed at the given
date, in the same order they were observed in the document.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>date</strong> – The date at which to look for an open entry. If not specified, will
return the entries still open at the latest date.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of Open directives.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_open_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gather the list of active Open entries at date.</span>

<span class="sd">    This returns the list of Open entries that have not been closed at the given</span>
<span class="sd">    date, in the same order they were observed in the document.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: The date at which to look for an open entry. If not specified, will</span>
<span class="sd">        return the entries still open at the latest date.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of Open directives.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">open_entries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Open</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ex_index</span><span class="p">,</span> <span class="n">ex_entry</span> <span class="o">=</span> <span class="n">open_entries</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">ex_entry</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
                    <span class="n">open_entries</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">open_entries</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Close</span><span class="p">):</span>
            <span class="c1"># If there is no corresponding open, don&#39;t raise an error.</span>
            <span class="n">open_entries</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">open_entries</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.open" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.open" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Summarize entries before a date and transfer income/expenses to equity.</p>
<p>This method essentially prepares a list of directives to contain only
transactions that occur after a particular date. It truncates the past. To
do so, it will</p>
<ol>
<li>
<p>Insert conversion transactions at the given open date, then</p>
</li>
<li>
<p>Insert transactions at that date to move accumulated balances from before
   that date from the income and expenses accounts to an equity account, and
   finally</p>
</li>
<li>
<p>It removes all the transactions previous to the date and replaces them by
   opening balances entries to bring the balances to the same amount.</p>
</li>
</ol>
<p>The result is a list of entries for which the income and expense accounts
are beginning with a balance of zero, and all other accounts begin with a
transaction that brings their balance to the expected amount. All the past
has been summarized at that point.</p>
<p>An index is returned to the first transaction past the balance opening
transactions, so you can keep just those in order to render a balance sheet
for only the opening balances.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directive tuples.</p></li>
            <li><p><strong>date</strong> – A datetime.date instance, the date at which to do this.</p></li>
            <li><p><strong>account_types</strong> – An instance of AccountTypes.</p></li>
            <li><p><strong>conversion_currency</strong> – A string, the transfer currency to use for zero prices
on the conversion entry.</p></li>
            <li><p><strong>account_earnings</strong> – A string, the name of the account to transfer
previous earnings from the income statement accounts to the balance
sheet.</p></li>
            <li><p><strong>account_opening</strong> – A string, the name of the account in equity
to transfer previous balances from, in order to initialize account
balances at the beginning of the period. This is typically called an
opening balances account.</p></li>
            <li><p><strong>account_conversions</strong> – A string, the name of the equity account to
book currency conversions against.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A new list of entries is returned, and the index that points to the first
original transaction after the beginning date of the period. This index
can be used to generate the opening balances report, which is a balance
sheet fed with only the summarized entries.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">open</span><span class="p">(</span>
    <span class="n">entries</span><span class="p">,</span>
    <span class="n">date</span><span class="p">,</span>
    <span class="n">account_types</span><span class="p">,</span>
    <span class="n">conversion_currency</span><span class="p">,</span>
    <span class="n">account_earnings</span><span class="p">,</span>
    <span class="n">account_opening</span><span class="p">,</span>
    <span class="n">account_conversions</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Summarize entries before a date and transfer income/expenses to equity.</span>

<span class="sd">    This method essentially prepares a list of directives to contain only</span>
<span class="sd">    transactions that occur after a particular date. It truncates the past. To</span>
<span class="sd">    do so, it will</span>

<span class="sd">    1. Insert conversion transactions at the given open date, then</span>

<span class="sd">    2. Insert transactions at that date to move accumulated balances from before</span>
<span class="sd">       that date from the income and expenses accounts to an equity account, and</span>
<span class="sd">       finally</span>

<span class="sd">    3. It removes all the transactions previous to the date and replaces them by</span>
<span class="sd">       opening balances entries to bring the balances to the same amount.</span>

<span class="sd">    The result is a list of entries for which the income and expense accounts</span>
<span class="sd">    are beginning with a balance of zero, and all other accounts begin with a</span>
<span class="sd">    transaction that brings their balance to the expected amount. All the past</span>
<span class="sd">    has been summarized at that point.</span>

<span class="sd">    An index is returned to the first transaction past the balance opening</span>
<span class="sd">    transactions, so you can keep just those in order to render a balance sheet</span>
<span class="sd">    for only the opening balances.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directive tuples.</span>
<span class="sd">      date: A datetime.date instance, the date at which to do this.</span>
<span class="sd">      account_types: An instance of AccountTypes.</span>
<span class="sd">      conversion_currency: A string, the transfer currency to use for zero prices</span>
<span class="sd">        on the conversion entry.</span>
<span class="sd">      account_earnings: A string, the name of the account to transfer</span>
<span class="sd">        previous earnings from the income statement accounts to the balance</span>
<span class="sd">        sheet.</span>
<span class="sd">      account_opening: A string, the name of the account in equity</span>
<span class="sd">        to transfer previous balances from, in order to initialize account</span>
<span class="sd">        balances at the beginning of the period. This is typically called an</span>
<span class="sd">        opening balances account.</span>
<span class="sd">      account_conversions: A string, the name of the equity account to</span>
<span class="sd">        book currency conversions against.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new list of entries is returned, and the index that points to the first</span>
<span class="sd">      original transaction after the beginning date of the period. This index</span>
<span class="sd">      can be used to generate the opening balances report, which is a balance</span>
<span class="sd">      sheet fed with only the summarized entries.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Insert conversion entries.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># Transfer income and expenses before the period to equity.</span>
    <span class="n">entries</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clear</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">)</span>

    <span class="c1"># Summarize all the previous balances, after transferring the income and</span>
    <span class="c1"># expense balances, so all entries for those accounts before the begin date</span>
    <span class="c1"># should now disappear.</span>
    <span class="n">entries</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">index</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.open_opt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">open_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.open_opt" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Convenience function to open() using an options map.</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">open_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience function to open() using an options map.&quot;&quot;&quot;</span>
    <span class="n">account_types</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">previous_accounts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_previous_accounts</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">conversion_currency</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s2">&quot;conversion_currency&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="o">*</span><span class="n">previous_accounts</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.summarize" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.summarize" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Summarize all entries before a date by replacing then with summarization entries.</p>
<p>This function replaces the transactions up to (and not including) the given
date with a opening balance transactions, one for each account. It returns
new entries, all of the transactions before the given date having been
replaced by a few summarization entries, one for each account.</p>
<p>Notes:
- Open entries are preserved for active accounts.
- The last relevant price entry for each (base, quote) pair is preserved.
- All other entries before the cutoff date are culled.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>date</strong> – A datetime.date instance, the cutoff date before which to summarize.</p></li>
            <li><p><strong>account_opening</strong> – A string, the name of the source account to book summarization
entries against.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>The function returns a list of new entries and the integer index at which
the entries on or after the cutoff date begin.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Summarize all entries before a date by replacing then with summarization entries.</span>

<span class="sd">    This function replaces the transactions up to (and not including) the given</span>
<span class="sd">    date with a opening balance transactions, one for each account. It returns</span>
<span class="sd">    new entries, all of the transactions before the given date having been</span>
<span class="sd">    replaced by a few summarization entries, one for each account.</span>

<span class="sd">    Notes:</span>
<span class="sd">    - Open entries are preserved for active accounts.</span>
<span class="sd">    - The last relevant price entry for each (base, quote) pair is preserved.</span>
<span class="sd">    - All other entries before the cutoff date are culled.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance, the cutoff date before which to summarize.</span>
<span class="sd">      account_opening: A string, the name of the source account to book summarization</span>
<span class="sd">        entries against.</span>
<span class="sd">    Returns:</span>
<span class="sd">      The function returns a list of new entries and the integer index at which</span>
<span class="sd">      the entries on or after the cutoff date begin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute balances at date.</span>
    <span class="n">balances</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">balance_by_account</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># We need to insert the entries with a date previous to subsequent checks,</span>
    <span class="c1"># to maintain ensure the open directives show up before any transaction.</span>
    <span class="n">summarize_date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Create summarization / opening balance entries.</span>
    <span class="n">summarizing_entries</span> <span class="o">=</span> <span class="n">create_entries_from_balances</span><span class="p">(</span>
        <span class="n">balances</span><span class="p">,</span>
        <span class="n">summarize_date</span><span class="p">,</span>
        <span class="n">account_opening</span><span class="p">,</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s2">&quot;&lt;summarize&gt;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">flags</span><span class="o">.</span><span class="n">FLAG_SUMMARIZE</span><span class="p">,</span>
        <span class="s2">&quot;Opening balance for &#39;</span><span class="si">{account}</span><span class="s2">&#39; (Summarization)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Insert the last price entry for each commodity from before the date.</span>
    <span class="n">price_entries</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">get_last_price_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># Gather the list of active open entries at date.</span>
    <span class="n">open_entries</span> <span class="o">=</span> <span class="n">get_open_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># Compute entries before the date and preserve the entries after the date.</span>
    <span class="n">before_entries</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">open_entries</span> <span class="o">+</span> <span class="n">price_entries</span> <span class="o">+</span> <span class="n">summarizing_entries</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">entry_sortkey</span>
    <span class="p">)</span>
    <span class="n">after_entries</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>

    <span class="c1"># Return a new list of entries and the index that points after the entries</span>
    <span class="c1"># were inserted.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">before_entries</span> <span class="o">+</span> <span class="n">after_entries</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">before_entries</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.transfer_balances" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">transfer_balances</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_pred</span><span class="p">,</span> <span class="n">transfer_account</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.transfer_balances" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Synthesize transactions to transfer balances from some accounts at a given date.</p>
<p>For all accounts that match the 'account_pred' predicate, create new entries
to transfer the balance at the given date from the account to the transfer
account. This is used to transfer balances from income and expenses from a
previous period to a "retained earnings" account. This is accomplished by
creating new entries.</p>
<p>Note that inserting transfers breaks any following balance checks that are
in the transferred accounts. For this reason, all balance assertion entries
following the cutoff date for those accounts are removed from the list in
output.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>date</strong> – A datetime.date instance, the date at which to make the transfer.</p></li>
            <li><p><strong>account_pred</strong> – A predicate function that, given an account string, returns
true if the account is meant to be transferred.</p></li>
            <li><p><strong>transfer_account</strong> – A string, the name of the source account to be used on
the transfer entries to receive balances at the given date.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A new list of entries, with the new transfer entries added in.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">transfer_balances</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_pred</span><span class="p">,</span> <span class="n">transfer_account</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Synthesize transactions to transfer balances from some accounts at a given date.</span>

<span class="sd">    For all accounts that match the &#39;account_pred&#39; predicate, create new entries</span>
<span class="sd">    to transfer the balance at the given date from the account to the transfer</span>
<span class="sd">    account. This is used to transfer balances from income and expenses from a</span>
<span class="sd">    previous period to a &quot;retained earnings&quot; account. This is accomplished by</span>
<span class="sd">    creating new entries.</span>

<span class="sd">    Note that inserting transfers breaks any following balance checks that are</span>
<span class="sd">    in the transferred accounts. For this reason, all balance assertion entries</span>
<span class="sd">    following the cutoff date for those accounts are removed from the list in</span>
<span class="sd">    output.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance, the date at which to make the transfer.</span>
<span class="sd">      account_pred: A predicate function that, given an account string, returns</span>
<span class="sd">        true if the account is meant to be transferred.</span>
<span class="sd">      transfer_account: A string, the name of the source account to be used on</span>
<span class="sd">        the transfer entries to receive balances at the given date.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new list of entries, with the new transfer entries added in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Don&#39;t bother doing anything if there are no entries.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">entries</span>

    <span class="c1"># Compute balances at date.</span>
    <span class="n">balances</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">balance_by_account</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># Filter out to keep only the accounts we want.</span>
    <span class="n">transfer_balances</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">account</span><span class="p">:</span> <span class="n">balance</span> <span class="k">for</span> <span class="n">account</span><span class="p">,</span> <span class="n">balance</span> <span class="ow">in</span> <span class="n">balances</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">account_pred</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># We need to insert the entries at the end of the previous day.</span>
    <span class="k">if</span> <span class="n">date</span><span class="p">:</span>
        <span class="n">transfer_date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transfer_date</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span>

    <span class="c1"># Create transfer entries.</span>
    <span class="n">transfer_entries</span> <span class="o">=</span> <span class="n">create_entries_from_balances</span><span class="p">(</span>
        <span class="n">transfer_balances</span><span class="p">,</span>
        <span class="n">transfer_date</span><span class="p">,</span>
        <span class="n">transfer_account</span><span class="p">,</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s2">&quot;&lt;transfer_balances&gt;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">flags</span><span class="o">.</span><span class="n">FLAG_TRANSFER</span><span class="p">,</span>
        <span class="s2">&quot;Transfer balance for &#39;</span><span class="si">{account}</span><span class="s2">&#39; (Transfer balance)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Remove balance assertions that occur after a transfer on an account that</span>
    <span class="c1"># has been transferred away; they would break.</span>
    <span class="n">after_entries</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">entry</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Balance</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">account</span> <span class="ow">in</span> <span class="n">transfer_balances</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Split the new entries in a new list.</span>
    <span class="k">return</span> <span class="n">entries</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">transfer_entries</span> <span class="o">+</span> <span class="n">after_entries</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.summarize.truncate" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">summarize</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span></code>


<a href="#beancount.ops.summarize.truncate" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Filter out all the entries at and after date. Returns a new list of entries.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A sorted list of directives.</p></li>
            <li><p><strong>date</strong> – A datetime.date instance.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A truncated list of directives.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/summarize.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter out all the entries at and after date. Returns a new list of entries.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A sorted list of directives.</span>
<span class="sd">      date: A datetime.date instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A truncated list of directives.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">bisect_key</span><span class="o">.</span><span class="n">bisect_left_with_key</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entries</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="beancount.ops.validation" class="doc doc-heading">
        <code>beancount.ops.validation</code>



<a href="#beancount.ops.validation" class="headerlink" title="Permanent link"></a></h2>

    <div class="doc doc-contents ">

      <p>Validation checks.</p>
<p>These checks are intended to be run after all the plugins have transformed the
list of entries, just before serving them or generating reports from them. The
idea is to ensure a reasonable set of invariants and generate errors if those
invariants are violated. They are not sanity checks--user data is subject to
constraints which are hopefully detected here and which will result in errors
trickled up to the user.</p>



  <div class="doc doc-children">













  <div class="doc doc-object doc-class">



<h3 id="beancount.ops.validation.ValidationError" class="doc doc-heading">
        <code>
beancount.ops.validation.ValidationError            (<span title="tuple">tuple</span>)
        </code>



<a href="#beancount.ops.validation.ValidationError" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>ValidationError(source, message, entry)</p>




  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="beancount.ops.validation.ValidationError.__getnewargs__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">ValidationError</span><span class="o">.</span><span class="n">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#beancount.ops.validation.ValidationError.__getnewargs__" class="headerlink" title="Permanent link"></a></h4>

    <div class="doc doc-contents ">

      <p>Return self as a plain tuple.  Used by copy and pickle.</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/validation.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">&#39;Return self as a plain tuple.  Used by copy and pickle.&#39;</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="beancount.ops.validation.ValidationError.__new__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">ValidationError</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#beancount.ops.validation.ValidationError.__new__" class="headerlink" title="Permanent link"></a></h4>

    <div class="doc doc-contents ">

      <p>Create new instance of ValidationError(source, message, entry)</p>

    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="beancount.ops.validation.ValidationError.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">ValidationError</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#beancount.ops.validation.ValidationError.__repr__" class="headerlink" title="Permanent link"></a></h4>

    <div class="doc doc-contents ">

      <p>Return a nicely formatted representation string</p>

        <details class="quote">
          <summary>Source code in <code>beancount/ops/validation.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">&#39;Return a nicely formatted representation string&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.validation.validate" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">log_timings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_validations</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#beancount.ops.validation.validate" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Perform all the standard checks on parsed contents.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>unused_options_map</strong> – An options map.</p></li>
            <li><p><strong>log_timings</strong> – An optional function to use for logging the time of individual
operations.</p></li>
            <li><p><strong>extra_validations</strong> – A list of extra validation functions to run after loading
this list of entries.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of new errors, if any were found.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/validation.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">log_timings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_validations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform all the standard checks on parsed contents.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">      log_timings: An optional function to use for logging the time of individual</span>
<span class="sd">        operations.</span>
<span class="sd">      extra_validations: A list of extra validation functions to run after loading</span>
<span class="sd">        this list of entries.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">validation_tests</span> <span class="o">=</span> <span class="n">VALIDATIONS</span>
    <span class="k">if</span> <span class="n">extra_validations</span><span class="p">:</span>
        <span class="n">validation_tests</span> <span class="o">+=</span> <span class="n">extra_validations</span>

    <span class="c1"># Run various validation routines define above.</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">validation_function</span> <span class="ow">in</span> <span class="n">validation_tests</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">misc_utils</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span>
            <span class="s2">&quot;function: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">validation_function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span> <span class="n">log_timings</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">):</span>
            <span class="n">new_errors</span> <span class="o">=</span> <span class="n">validation_function</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_errors</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.validation.validate_active_accounts" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">validate_active_accounts</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.validation.validate_active_accounts" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Check that all references to accounts occurs on active accounts.</p>
<p>We basically check that references to accounts from all directives other
than Open and Close occur at dates the open-close interval of that account.
This should be good for all of the directive types where we can extract an
account name.</p>
<p>Note that this is more strict a check than comparing the dates: we actually
check that no references to account are made on the same day before the open
directive appears for that account. This is a nice property to have, and is
supported by our custom sorting routine that will sort open entries before
transaction entries, given the same date.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>unused_options_map</strong> – An options map.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of new errors, if any were found.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/validation.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_active_accounts</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that all references to accounts occurs on active accounts.</span>

<span class="sd">    We basically check that references to accounts from all directives other</span>
<span class="sd">    than Open and Close occur at dates the open-close interval of that account.</span>
<span class="sd">    This should be good for all of the directive types where we can extract an</span>
<span class="sd">    account name.</span>

<span class="sd">    Note that this is more strict a check than comparing the dates: we actually</span>
<span class="sd">    check that no references to account are made on the same day before the open</span>
<span class="sd">    directive appears for that account. This is a nice property to have, and is</span>
<span class="sd">    supported by our custom sorting routine that will sort open entries before</span>
<span class="sd">    transaction entries, given the same date.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">active_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">opened_accounts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">):</span>
            <span class="n">active_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
            <span class="n">opened_accounts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Close</span><span class="p">):</span>
            <span class="n">active_set</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_entry_accounts</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">account</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">active_set</span><span class="p">:</span>
                    <span class="c1"># Allow document and note directives that occur after an</span>
                    <span class="c1"># account is closed.</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">ALLOW_AFTER_CLOSE</span><span class="p">)</span> <span class="ow">and</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">opened_accounts</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Register an error to be logged later, with an appropriate</span>
                    <span class="c1"># message.</span>
                    <span class="n">error_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">account</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>

    <span class="c1"># Refine the error message to disambiguate between the case of an account</span>
    <span class="c1"># that has never been seen and one that was simply not active at the time.</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">account</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">error_pairs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">opened_accounts</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Invalid reference to inactive account &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Invalid reference to unknown account &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.validation.validate_check_transaction_balances" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">validate_check_transaction_balances</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.validation.validate_check_transaction_balances" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Check again that all transaction postings balance, as users may have
transformed transactions.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>unused_options_map</strong> – An options map.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of new errors, if any were found.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/validation.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_check_transaction_balances</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check again that all transaction postings balance, as users may have</span>
<span class="sd">    transformed transactions.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Note: this is a bit slow; we could limit our checks to the original</span>
    <span class="c1"># transactions by using the hash function in the loader.</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">):</span>
            <span class="c1"># IMPORTANT: This validation is _crucial_ and cannot be skipped.</span>
            <span class="c1"># This is where we actually detect and warn on unbalancing</span>
            <span class="c1"># transactions. This _must_ come after the user routines, because</span>
            <span class="c1"># unbalancing input is legal, as those types of transactions may be</span>
            <span class="c1"># &quot;fixed up&quot; by a user-plugin. In other words, we want to allow</span>
            <span class="c1"># users to input unbalancing transactions as long as the final</span>
            <span class="c1"># transactions objects that appear on the stream (after processing</span>
            <span class="c1"># the plugins) are balanced. See {9e6c14b51a59}.</span>
            <span class="c1">#</span>
            <span class="c1"># Detect complete sets of postings that have residual balance;</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">compute_residual</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">)</span>
            <span class="n">tolerances</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">infer_tolerances</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">residual</span><span class="o">.</span><span class="n">is_small</span><span class="p">(</span><span class="n">tolerances</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">&quot;Transaction does not balance: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">residual</span><span class="p">),</span>
                        <span class="n">entry</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.validation.validate_currency_constraints" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">validate_currency_constraints</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.validation.validate_currency_constraints" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Check the currency constraints from account open declarations.</p>
<p>Open directives admit an optional list of currencies that specify the only
types of commodities that the running inventory for this account may
contain. This function checks that all postings are only made in those
commodities.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>unused_options_map</strong> – An options map.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of new errors, if any were found.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/validation.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_currency_constraints</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the currency constraints from account open declarations.</span>

<span class="sd">    Open directives admit an optional list of currencies that specify the only</span>
<span class="sd">    types of commodities that the running inventory for this account may</span>
<span class="sd">    contain. This function checks that all postings are only made in those</span>
<span class="sd">    commodities.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get all the open entries with currency constraints.</span>
    <span class="n">open_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">:</span> <span class="n">entry</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Open</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">currencies</span>
    <span class="p">}</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="c1"># Look up the corresponding account&#39;s valid currencies; skip the</span>
            <span class="c1"># check if there are none specified.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">open_entry</span> <span class="o">=</span> <span class="n">open_map</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>
                <span class="n">valid_currencies</span> <span class="o">=</span> <span class="n">open_entry</span><span class="o">.</span><span class="n">currencies</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_currencies</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Perform the check.</span>
            <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_currencies</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">&quot;Invalid currency </span><span class="si">{}</span><span class="s2"> for account &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">account</span>
                        <span class="p">),</span>
                        <span class="n">entry</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.validation.validate_data_types" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">validate_data_types</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.validation.validate_data_types" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Check that all the data types of the attributes of entries are as expected.</p>
<p>Users are provided with a means to filter the list of entries. They're able to
write code that manipulates those tuple objects without any type constraints.
With discipline, this mostly works, but I know better: check, just to make sure.
This routine checks all the data types and assumptions on entries.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>unused_options_map</strong> – An options map.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of new errors, if any were found.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/validation.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_data_types</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that all the data types of the attributes of entries are as expected.</span>

<span class="sd">    Users are provided with a means to filter the list of entries. They&#39;re able to</span>
<span class="sd">    write code that manipulates those tuple objects without any type constraints.</span>
<span class="sd">    With discipline, this mostly works, but I know better: check, just to make sure.</span>
<span class="sd">    This routine checks all the data types and assumptions on entries.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">sanity_check_types</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span> <span class="n">options_map</span><span class="p">[</span><span class="s2">&quot;allow_deprecated_none_for_tags_and_links&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ValidationError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="s2">&quot;Invalid data types: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="n">entry</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">errors</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.validation.validate_documents_paths" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">validate_documents_paths</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.validation.validate_documents_paths" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Check that all filenames in resolved Document entries are absolute filenames.</p>
<p>The processing of document entries is assumed to result in absolute paths.
Relative paths are resolved at the parsing stage and at point we want to
make sure we don't have to do any further processing on them.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>unused_options_map</strong> – An options map.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of new errors, if any were found.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/validation.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_documents_paths</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that all filenames in resolved Document entries are absolute filenames.</span>

<span class="sd">    The processing of document entries is assumed to result in absolute paths.</span>
<span class="sd">    Relative paths are resolved at the parsing stage and at point we want to</span>
<span class="sd">    make sure we don&#39;t have to do any further processing on them.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">ValidationError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="s2">&quot;Invalid relative path for entry&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Document</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
    <span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.validation.validate_duplicate_balances" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">validate_duplicate_balances</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.validation.validate_duplicate_balances" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Check that balance entries occur only once per day.</p>
<p>Because we do not support time, and the declaration order of entries is
meant to be kept irrelevant, two balance entries with different amounts
should not occur in the file. We do allow two identical balance assertions,
however, because this may occur during import.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>unused_options_map</strong> – An options map.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of new errors, if any were found.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/validation.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_duplicate_balances</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that balance entries occur only once per day.</span>

<span class="sd">    Because we do not support time, and the declaration order of entries is</span>
<span class="sd">    meant to be kept irrelevant, two balance entries with different amounts</span>
<span class="sd">    should not occur in the file. We do allow two identical balance assertions,</span>
<span class="sd">    however, because this may occur during import.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Mapping of (account, currency, date) to Balance entry.</span>
    <span class="n">balance_entries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Balance</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">previous_entry</span> <span class="o">=</span> <span class="n">balance_entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">amount</span> <span class="o">!=</span> <span class="n">previous_entry</span><span class="o">.</span><span class="n">amount</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">&quot;Duplicate balance assertion with different amounts&quot;</span><span class="p">,</span>
                        <span class="n">entry</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">balance_entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.validation.validate_duplicate_commodities" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">validate_duplicate_commodities</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.validation.validate_duplicate_commodities" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Check that commodity entries are unique for each commodity.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>unused_options_map</strong> – An options map.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of new errors, if any were found.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/validation.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_duplicate_commodities</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that commodity entries are unique for each commodity.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Mapping of (account, currency, date) to Balance entry.</span>
    <span class="n">commodity_entries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Commodity</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">currency</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">previous_entry</span> <span class="o">=</span> <span class="n">commodity_entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">previous_entry</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">&quot;Duplicate commodity directives for &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                        <span class="n">entry</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">commodity_entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="beancount.ops.validation.validate_open_close" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beancount</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">validate_open_close</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span></code>


<a href="#beancount.ops.validation.validate_open_close" class="headerlink" title="Permanent link"></a></h3>

    <div class="doc doc-contents ">

      <p>Check constraints on open and close directives themselves.</p>
<p>This method checks two kinds of constraints:</p>
<ol>
<li>
<p>An open or a close directive may only show up once for each account. If a
   duplicate is detected, an error is generated.</p>
</li>
<li>
<p>Close directives may only appear if an open directive has been seen
   previously (chronologically).</p>
</li>
<li>
<p>The date of close directives must be strictly greater than their
   corresponding open directive.</p>
</li>
</ol>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>entries</strong> – A list of directives.</p></li>
            <li><p><strong>unused_options_map</strong> – An options map.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p>A list of new errors, if any were found.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>beancount/ops/validation.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_open_close</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check constraints on open and close directives themselves.</span>

<span class="sd">    This method checks two kinds of constraints:</span>

<span class="sd">    1. An open or a close directive may only show up once for each account. If a</span>
<span class="sd">       duplicate is detected, an error is generated.</span>

<span class="sd">    2. Close directives may only appear if an open directive has been seen</span>
<span class="sd">       previously (chronologically).</span>

<span class="sd">    3. The date of close directives must be strictly greater than their</span>
<span class="sd">       corresponding open directive.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">open_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">close_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Open</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">account</span> <span class="ow">in</span> <span class="n">open_map</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">&quot;Duplicate open directive for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                        <span class="n">entry</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">open_map</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Close</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">account</span> <span class="ow">in</span> <span class="n">close_map</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">&quot;Duplicate close directive for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                        <span class="n">entry</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">open_entry</span> <span class="o">=</span> <span class="n">open_map</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">open_entry</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">ValidationError</span><span class="p">(</span>
                                <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                <span class="s2">&quot;Internal error: closing date for </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                <span class="s2">&quot;appears before opening date&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                                <span class="n">entry</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">ValidationError</span><span class="p">(</span>
                            <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                            <span class="s2">&quot;Unopened account </span><span class="si">{}</span><span class="s2"> is being closed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                            <span class="n">entry</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">close_map</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="beancount.parser.html" class="btn btn-neutral float-right" title="beancount.parser">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="beancount.loader.html" class="btn btn-neutral" title="beancount.loader"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="beancount.loader.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="beancount.parser.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
