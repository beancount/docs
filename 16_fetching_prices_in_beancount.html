<!DOCTYPE html>

<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://xuhcc.github.io/beancount-docs/16_fetching_prices_in_beancount.html" rel="canonical"/>
<link href="img/favicon.ico" rel="shortcut icon"/>
<title>Fetching Prices in Beancount - Beancount Documentation</title>
<link href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet">
<link href="css/theme.css" rel="stylesheet">
<link href="css/theme_extra.css" rel="stylesheet"/>
<link href="css/custom.css" rel="stylesheet"/>
<script>
    // Current page data
    var mkdocs_page_name = "Fetching Prices in Beancount";
    var mkdocs_page_input_path = "16_fetching_prices_in_beancount.md";
    var mkdocs_page_url = "/beancount-docs/16_fetching_prices_in_beancount.html";
  </script>
<script defer="" src="js/jquery-2.1.1.min.js"></script>
<script defer="" src="js/modernizr-2.8.3.min.js"></script>
</link></link></head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href="."> Beancount Documentation</a>
</div>
<div aria-label="main navigation" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Index</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Outline</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal current" href="#">Documentation for Users</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_command_line_accounting_in_context.html">Command Line Accounting in Context</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="02_the_double_entry_counting_method.html">The Double Entry Counting Method</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="03_installing_beancount.html">Installing Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="04_running_beancount_and_generating_reports.html">Running Beancount and Generating Reports</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="05_getting_started_with_beancount.html">Getting Started with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="06_beancount_language_syntax.html">Beancount Language Syntax</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="07_beancount_options_reference.html">Beancount Options Reference</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="08_precision_tolerances.html">Precision Tolerances</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="09_beancount_query_language.html">Beancount Query Language</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="10_beancount_cheat_sheet.html">Beancount Cheat Sheet</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="11_how_inventories_work.html">How Inventories Work</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="12_exporting_your_portfolio.html">Exporting Your Portfolio</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="13_tutorial_example.html">Tutorial &amp; Example</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="14_beancount_history_and_credits.html">Beancount History and Credits</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="15_a_comparison_of_beancount_and_ledger_hledger.html">A Comparison of Beancount and Ledger Hledger</a>
</li>
<li class="toctree-l2 current"><a class="reference internal current" href="16_fetching_prices_in_beancount.html">Fetching Prices in Beancount</a>
<ul class="current">
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-problem">The Problem</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-bean-price-tool">The “bean-price” Tool</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#source-strings">Source Strings</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#fallback-sources">Fallback Sources</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#inverted-prices">Inverted Prices</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#date">Date </a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#caching">Caching</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#prices-from-a-beancount-input-file">Prices from a Beancount Input File</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#which-assets-are-fetched">Which Assets are Fetched</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#conclusion">Conclusion</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#writing-your-own-script">Writing Your Own Script</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#contributions">Contributions</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="17_importing_external_data.html">Importing External Data</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Cookbooks &amp; Examples</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="18_command_line_accounting_cookbook.html">Command Line Accounting Cookbook</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="19_trading_with_beancount.html">Trading with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="20_stock_vesting_in_beancount.html">Stock Vesting in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="21_sharing_expenses_with_beancount.html">Sharing Expenses with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="22_how_we_share_expenses.html">How We Share Expenses</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Documentation for Developers</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="23_beancount_scripting_plugins.html">Beancount Scripting Plugins</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="24_beancount_design_doc.html">Beancount Design Doc</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="25_ledgerhub_design_doc.html">Ledgerhub Design Doc</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="26_external_contributions.html">External Contributions</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Enhancement Proposals &amp; Discussions</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="27_a_proposal_for_an_improvement_on_inventory_booking.html">A Proposal for an Improvement on Inventory Booking</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="28_settlement_dates_in_beancount.html">Settlement Dates in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="29_balance_assertions_in_beancount.html">Balance Assertions in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="30_fund_accounting_with_beancount.html">Fund Accounting with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="31_rounding_precision_in_beancount.html">Rounding Precision in Beancount</a>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api_reference/index.html">beancount</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="api_reference/beancount.core.html">beancount.core</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="api_reference/beancount.ingest.html">beancount.ingest</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="api_reference/beancount.ops.html">beancount.ops</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="api_reference/beancount.parser.html">beancount.parser</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="api_reference/beancount.plugins.html">beancount.plugins</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="api_reference/beancount.query.html">beancount.query</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="api_reference/beancount.reports.html">beancount.reports</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="api_reference/beancount.scripts.html">beancount.scripts</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="api_reference/beancount.utils.html">beancount.utils</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="top navigation" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href=".">Beancount Documentation</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a href=".">Docs</a> »</li>
<li>Documentation for Users »</li>
<li>Outline »</li>
<li>Fetching Prices in Beancount</li>
<li class="wy-breadcrumbs-aside">
<a class="icon icon-github" href="https://github.com/xuhcc/beancount-docs/edit/master/docs/16_fetching_prices_in_beancount.md"> Edit on GitHub</a>
</li>
</ul>
<hr/>
</div>
<div role="main">
<div class="section">
<h1 id="prices-in-beancount">Prices in Beancount<a id="title"></a><a class="headerlink" href="#prices-in-beancount" title="Permanent link"></a></h1>
<p><a href="mailto:blais@furius.ca">Martin</a> <a href="mailto:blais@furius.ca">Blais</a>, December 2015</p>
<p><a href="http://furius.ca/beancount/doc/prices"><span class="underline">http://furius.ca/beancount/doc/prices</span></a></p>
<h2 id="introduction">Introduction<a id="introduction"></a><a class="headerlink" href="#introduction" title="Permanent link"></a></h2>
<p>Processing a Beancount file is, by definition, constrained to the contents of the file itself. In particular, the latest prices of commodities are <em>never</em> fetched automatically from the internet. This is by design, so that any run of a report is deterministic and can also be run offline. No surprises.</p>
<p>However, we do need access to price information in order to compute market values of assets. To this end, Beancount provides a Price directive which can be used to fill its in-memory price database by inserting these price points inline in the input file:</p>
<pre><code>2015-11-20 price ITOT    95.46 USD
2015-11-20 price LQD    115.63 USD
2015-11-21 price USD   1.33495 CAD
…
</code></pre>
<p>Of course, you could do this manually, looking up the prices online and writing the directives yourself. But for assets which are traded publicly you can automate it, by invoking some code that will download prices and write out the directives for you.</p>
<p>Beancount comes with some tools to help you do this. This document describes these tools.</p>
<h2 id="the-problem">The Problem<a id="the-problem"></a><a class="headerlink" href="#the-problem" title="Permanent link"></a></h2>
<p>In the context of maintaining a Beancount file, we have a few particular needs to address.</p>
<p>First, we cannot expect the user to always update the input file in a timely manner. This means that we have to be able to fetch not only the latest prices, but also historical prices, from the past. Beancount provides an interface to provide these prices and a few implementations (fetching from Yahoo! Finance and from Google Finance).</p>
<p>Second, we don't want to store too many prices for holdings which aren't relevant to us at a particular point in time. The list of assets held in a file varies over time. Ideally we would want to include the list of prices for just those assets, while they are held. The Beancount price maintenance tool is able to figure out which commodities it needs to fetch prices for at a particular date.</p>
<p>Third, we don't want to fetch the same price if it already appears in the input file. The tools detect this and skip those prices. There's also a caching mechanism that avoids redundant network calls.</p>
<p>Finally, while we provide some basic implementations of price sources, we cannot provide such codes for all possible online sources and websites. The problem is analogous to that of importing and extracting data from various institutions. In order to address that, we provide a mechanism for <strong>extensibility</strong>, a way that you can implement your own price source fetcher in a Python module and point to it from your input file by specifying the module's name as the source for that commodity.</p>
<h2 id="the-bean-price-tool">The “bean-price” Tool<a id="the-bean-price-tool"></a><a class="headerlink" href="#the-bean-price-tool" title="Permanent link"></a></h2>
<p>Beancount comes with a “bean-price” command-line tool that integrates the ideas above. By default, this script accepts a list of Beancount input filenames, and fetches prices required to compute latest market values for current positions held in accounts:</p>
<pre><code>bean-price /home/joe/finances/joe.beancount
</code></pre>
<p>It is also possible to provide a list of specific price fetching jobs to run, e.g.,</p>
<pre><code>bean-price -e USD:google/TSE:XUS CAD:mysources.morningstar/RBF1005
</code></pre>
<p>These jobs are run concurrently so it should be fairly fast.</p>
<h3 id="source-strings">Source Strings<a id="source-strings"></a><a class="headerlink" href="#source-strings" title="Permanent link"></a></h3>
<p>The general format of each of these "job source strings" is</p>
<p>&lt;quote-currency&gt;:&lt;module&gt;/[^]&lt;symbol&gt;</p>
<p>For example:</p>
<pre><code>USD:beancount.prices.sources.google/NASDAQ:AAPL
</code></pre>
<p>The “quote-currency” is the currency the Commodity is quoted in. For example, shares of Apple are quoted in US dollars.</p>
<p>The "module" is the name of a Python module that contains a Source class which can be instantiated and which connect to a data source to extract price data. These modules are automatically imported and a Source class therein instantiated in order to pull the price from the particular online source they support. This allows you to write your own fetcher codes without having to modify this script. Your code can be placed anywhere on your Python PYTHONPATH and you should not have to modify Beancount itself for this to work.</p>
<p>The “symbol” is a string that is fed to the price fetcher to lookup the currency. For example, Apple shares trade on the Nasdaq, and the corresponding symbol in the Google Finance source is “NASDAQ:AAPL”. Other price sources may have a different symbology, e.g., some may require the asset's CUSIP.</p>
<p>Default implementations of price sources are provided; we provide fetchers for Yahoo! Finance or Google Finance, which cover a large universe of common public investment types (e.g. stock and some mutual funds). As a convenience, the module name is always first searched under the "beancount.prices.sources" package, where those implementations live. This is how, for example, in order to use the provided Yahoo! Finance data fetcher you don't have to write all of "beancount.prices.sources.yahoo/AAPL" but you can simply use "yahoo/AAPL".</p>
<h3 id="fallback-sources">Fallback Sources<a id="fallback-sources"></a><a class="headerlink" href="#fallback-sources" title="Permanent link"></a></h3>
<p>In practice, fetching prices online often fails. Data sources typically only support some limited number of assets and even then, the support may vary between assets. As an example, Google Finance supports historical prices for stocks, but does not return historical prices for currency instruments (these restrictions may be more related to contractual arrangements between them and the data providers upstream than with technical limitations).</p>
<p>To this extent, a source string may provide multiple sources for the data, separated with commas. For example:</p>
<pre><code>USD:google/CURRENCY:GBPUSD,yahoo/GBPUSD
</code></pre>
<p>Each source is tried in turn, and if one fails to return a valid price, the next source is tried as a fallback. The hope is that at least one of the specified sources will work out.</p>
<h3 id="inverted-prices">Inverted Prices<a id="inverted-prices"></a><a class="headerlink" href="#inverted-prices" title="Permanent link"></a></h3>
<p>Sometimes, prices are only available for the inverse of an instrument. This is often the case for currencies. For example, the price of Canadian dollars quoted in US dollars is provided by the USD/CAD market, which gives the price of a US dollar in Canadian dollars (the inverse). In order use this, you can prepend "^" to the instrument name to instruct the tool to compute the inverse of the fetched price:</p>
<pre><code>USD:google/^CURRENCY:USDCAD
</code></pre>
<p>If a source price is to be inverted, like this, the precision could be different than what is fetched. For instance, if the price of USD/CAD is 1.32759, for the above directive to price the “CAD” instrument it would output this:</p>
<p>2015-10-28 price CAD 0.753244601119 USD</p>
<p>By default, inverted rates will be rounded similarly to how other Price directives were rounding those numbers.</p>
<p>As you may now, Beancount's in-memory price database works in both directions (the reciprocals of all rates are stored automatically). So if you prefer to have the output Price entries with swapped currencies instead of inverting the rate number itself, you can use the --swap-inverted option. In the previous example for the price of CAD, it would output this:</p>
<p>2015-10-28 price USD 1.32759 CAD</p>
<h3 id="date">Date <a id="date"></a><a class="headerlink" href="#date" title="Permanent link"></a></h3>
<p>By default, the latest prices for the assets are pulled in. You can use an option to fetch prices for a desired date in the past instead:</p>
<pre><code>bean-price –date=2015-02-03 …
</code></pre>
<p>If you are using an input file to specify the list of prices to be fetched, the tool will figure out the list of assets held on the books <em>at that time</em> and fetch historical prices for those assets only.</p>
<h3 id="caching">Caching<a id="caching"></a><a class="headerlink" href="#caching" title="Permanent link"></a></h3>
<p>Prices are automatically cached (if current and latest, prices are cached for only a short period of time, about half an hour). This is convenient when you're having to run the script multiple times in a row for troubleshooting.</p>
<p>You can disable the cache with an option:</p>
<pre><code>bean-price --no-cache
</code></pre>
<p>You can also instruct the script to clear the cache before fetching its prices:</p>
<pre><code>bean-price --clear-cache
</code></pre>
<h2 id="prices-from-a-beancount-input-file">Prices from a Beancount Input File<a id="prices-from-a-beancount-input-file"></a><a class="headerlink" href="#prices-from-a-beancount-input-file" title="Permanent link"></a></h2>
<p>Generally, one uses a Beancount input file to specify the list of currencies to fetch. In order to do that, you should have Commodity directives in your input file for each of the currencies you mean to fetch prices for, like this:</p>
<pre><code>2007-07-20 commodity VEA
</code></pre>
<p><strong>price: "USD:google/NYSEARCA:VEA"</strong></p>
<p>The "price" metadata should contain a list of price source strings. For example, a stock product might look like this:</p>
<pre><code>2007-07-20 commodity CAD

  price: "USD:google/CURRENCY:USDCAD,yahoo/USDCAD"
</code></pre>
<p>While a currency may have multiple target currencies it needs to get converted to:</p>
<pre><code>1990-01-01 commodity GBP

  price: "USD:yahoo/GBPUSD CAD:yahoo/GBPCAD CHF:yahoo/GBPCHF"
</code></pre>
<h3 id="which-assets-are-fetched">Which Assets are Fetched<a id="which-assets-are-fetched"></a><a class="headerlink" href="#which-assets-are-fetched" title="Permanent link"></a></h3>
<p>There are many ways to compute a list of commodities with needed prices from a Beancount input file:</p>
<ol>
<li>
<p><strong>Commodity directives.</strong> The list of all Commodity directives with “price” metadata present in the file. For each of those holdings, the directive is consulted and its "price" metadata field is used to specify where to fetch prices from.</p>
</li>
<li>
<p><strong>Commodities of assets held at cost.</strong> Prices for all the holdings that were seen held at cost at a particular date. Because these holdings are held at cost, we can assume there is a corresponding time-varying price for their commodity.</p>
</li>
<li>
<p><strong>Converted commodities.</strong> Prices for holdings which were price-converted from some other commodity in the past (i.e., converting some cash in a currency from another).</p>
</li>
</ol>
<p>By default, the list of tickers to be fetched includes only the intersection of these three lists. This is because the most common usage of this script is to fetch missing prices for a particular date, and only the needed ones.</p>
<p><strong>Inactive commodities.</strong> You can use the “--inactive” option to fetch the entire set of prices from (1), regardless of asset holdings determined in (2) and (3).</p>
<p><strong>Undeclared commodities.</strong> Commodities without a corresponding “Commodity” directive will be ignored by default. To include the full list of commodities seen in an input file, use the “--undeclared” option.</p>
<p><strong>Clobber.</strong> Existing price directives for the same data are excluded by default, since the price is already in the file. You can use “--clobber” to ignore existing price directives and avoid filtering out what is fetched.</p>
<p>Finally, you can use “--all” to include inactive and undeclared commodities and allow clobbering existing ones. You probably don't want to use that other than for testing.</p>
<p>If you'd like to do some troubleshooting and print out the list of seen commodities, use the “--verbose” option twice, i.e., “-vv”. You can also just print the list of prices to be fetched with the “--dry-run” option, which stops short of actually fetching the missing prices.</p>
<h2 id="conclusion">Conclusion<a id="conclusion"></a><a class="headerlink" href="#conclusion" title="Permanent link"></a></h2>
<h3 id="writing-your-own-script">Writing Your Own Script<a id="writing-your-own-script"></a><a class="headerlink" href="#writing-your-own-script" title="Permanent link"></a></h3>
<p>If the workflow defined by this tool does not fit your needs and you would like to cook up your own script, you should not have to start from scratch; you should be able to reuse the existing price fetching code to do that. I'm hoping to provide a few examples of such scripts in the experiments directory. For example, given an existing file it would be convenient to fetch all prices of assets every Friday in order to fill up a history of missing prices. Another example would be to fetch all price directives required in order to correctly compute investment returns in the presence of contributions and distributions.</p>
<h3 id="contributions">Contributions<a id="contributions"></a><a class="headerlink" href="#contributions" title="Permanent link"></a></h3>
<p>If this workflow suits your needs well and you'd like to contribute some price source fetcher to Beancount, please contact the mailing-list. I'm open to including very general fetchers that have been very carefully unit-tested and used for a while.</p>
</div>
</div>
<footer>
<div aria-label="footer navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-right" href="17_importing_external_data.html" title="Importing External Data">Next <span class="icon icon-circle-arrow-right"></span></a>
<a class="btn btn-neutral" href="15_a_comparison_of_beancount_and_ledger_hledger.html" title="A Comparison of Beancount and Ledger Hledger"><span class="icon icon-circle-arrow-left"></span> Previous</a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<a class="fa fa-github" href="https://github.com/xuhcc/beancount-docs/" style="float: left; color: #fcfcfc"> GitHub</a>
<span><a href="15_a_comparison_of_beancount_and_ledger_hledger.html" style="color: #fcfcfc;">« Previous</a></span>
<span style="margin-left: 15px"><a href="17_importing_external_data.html" style="color: #fcfcfc">Next »</a></span>
</span>
</div>
<script>var base_url = '.';</script>
<script defer="" src="js/theme.js"></script>
<script defer="" src="js/extra.js"></script>
<script defer="">
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>
</body>
</html>
